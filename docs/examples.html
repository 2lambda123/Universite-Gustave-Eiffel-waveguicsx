<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Examples &mdash; waveguicsx  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="waveguicsx.waveguide" href="waveguicsx.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> waveguicsx
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="readme_link.html">waveguicsx</a></li>
<li class="toctree-l1"><a class="reference internal" href="modules.html">Modules</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#elastic-waveguide-squarebar3d-py">Elastic_Waveguide_SquareBar3D.py</a></li>
<li class="toctree-l2"><a class="reference internal" href="#elastic-waveguide-squarebar3d-parallelizedloop-py">Elastic_Waveguide_SquareBar3D_ParallelizedLoop.py</a></li>
<li class="toctree-l2"><a class="reference internal" href="#elastic-waveguide-squarebar3d-pml-py">Elastic_Waveguide_SquareBar3D_PML.py</a></li>
<li class="toctree-l2"><a class="reference internal" href="#elastic-waveguide-squarebar3d-pml-gmsh-py">Elastic_Waveguide_SquareBar3D_PML_Gmsh.py</a></li>
<li class="toctree-l2"><a class="reference internal" href="#elastic-waveguide-circularbar3d-forcedresponse-gmsh-py">Elastic_Waveguide_CircularBar3D_ForcedResponse_Gmsh.py</a></li>
<li class="toctree-l2"><a class="reference internal" href="#elastic-waveguide-circularbar3d-forcedresponse-gmsh-parallelizedloop-py">Elastic_Waveguide_CircularBar3D_ForcedResponse_Gmsh_ParallelizedLoop.py</a></li>
<li class="toctree-l2"><a class="reference internal" href="#elastic-waveguide-plate2d-transientresponse-py">Elastic_Waveguide_Plate2D_TransientResponse.py</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">waveguicsx</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a></li>
      <li class="breadcrumb-item active">Examples</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/examples.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="examples">
<h1>Examples<a class="headerlink" href="#examples" title="Permalink to this heading"></a></h1>
<section id="elastic-waveguide-squarebar3d-py">
<h2>Elastic_Waveguide_SquareBar3D.py<a class="headerlink" href="#elastic-waveguide-squarebar3d-py" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This file is a tutorial for waveguicsx (*), whose inputs are</span>
<span class="c1"># the matrices K0, K1, K2, M and the excitation vector F.</span>
<span class="c1"># In the tutorial, K0, K1, K2 and M are finite element matrices generated by FEnicSX (**).</span>
<span class="c1">#  (*) waveguicsx is a python library for solving complex waveguide problems</span>
<span class="c1">#      Copyright (C) 2023  Fabien Treyssede</span>
<span class="c1">#      waveguicsx is free software distributed under the GNU General Public License</span>
<span class="c1">#      (https://github.com/treyssede/waveguicsx)</span>
<span class="c1"># (**) FEniCSx is an open-source computing platform for solving partial differential equations</span>
<span class="c1">#      distributed under the GNU Lesser General Public License (https://fenicsproject.org/)</span>

<span class="c1">##################################</span>
<span class="c1"># 3D (visco-)elastic waveguide example\</span>
<span class="c1"># The cross-section is a 2D square with free boundary conditions on its boundaries\</span>
<span class="c1"># material: viscoelastic steel\</span>
<span class="c1"># The waveguide FE formulation (SAFE) leads to the following eigenvalue problem:\</span>
<span class="c1"># $(\textbf{K}_1-\omega^2\textbf{M}+\text{i}k(\textbf{K}_2+\textbf{K}_2^\text{T})+k^2\textbf{K}_3)\textbf{U}=\textbf{0}$\</span>
<span class="c1"># This eigenproblem is solved with the varying parameter as the wavenumber (eigenvalues are then frequencies) or as the frequency (eigenvalues are then wavenumbers)\</span>
<span class="c1"># Viscoelastic loss is included by introducing imaginary parts (negative) to wave celerities\</span>
<span class="c1"># Results are compared with Euler-Bernoulli analytical solutions for the lowest wavenumber or frequency parameter</span>

<span class="kn">import</span> <span class="nn">dolfinx</span>
<span class="kn">import</span> <span class="nn">ufl</span>
<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">from</span> <span class="nn">petsc4py</span> <span class="kn">import</span> <span class="n">PETSc</span>
<span class="kn">from</span> <span class="nn">slepc4py</span> <span class="kn">import</span> <span class="n">SLEPc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pyvista</span>

<span class="kn">from</span> <span class="nn">waveguicsx.waveguide</span> <span class="kn">import</span> <span class="n">Waveguide</span>
<span class="c1">#For proper use with a jupyter notebook, uncomment the following line:</span>
<span class="c1">#pyvista.set_jupyter_backend(&quot;none&quot;); pyvista.start_xvfb() #try also: &quot;static&quot;, &quot;pythreejs&quot;, &quot;ipyvtklink&quot;...</span>

<span class="c1">##################################</span>
<span class="c1"># Input parameters</span>
<span class="n">a</span> <span class="o">=</span> <span class="mf">2.7e-3</span> <span class="c1">#core half-length (m)</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1">#number of finite elements along one half-side</span>
<span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="mi">7932</span><span class="p">,</span> <span class="mi">3260</span><span class="p">,</span> <span class="mi">5960</span> <span class="c1">#core density (kg/m3), shear and longitudinal wave celerities (m/s)</span>
<span class="n">kappas</span><span class="p">,</span> <span class="n">kappal</span> <span class="o">=</span> <span class="mf">0.008</span><span class="p">,</span> <span class="mf">0.003</span> <span class="c1">#core shear and longitudinal bulk wave attenuations (Np/wavelength)</span>
<span class="n">omega</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">500e3</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="mf">500e3</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span> <span class="c1">#angular frequency range (rad/s)</span>
<span class="n">wavenumber</span> <span class="o">=</span> <span class="n">omega</span><span class="o">/</span><span class="n">cs</span> <span class="c1">#wavenumber range (1/m, eigenvalues are frequency)</span>
<span class="n">nev</span> <span class="o">=</span> <span class="mi">20</span> <span class="c1">#number of eigenvalues</span>

<span class="c1">##################################</span>
<span class="c1"># Re-scaling</span>
<span class="n">L0</span> <span class="o">=</span> <span class="n">a</span> <span class="c1">#characteristic length</span>
<span class="n">T0</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">cs</span> <span class="c1">#characteristic time</span>
<span class="n">M0</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">a</span><span class="o">**</span><span class="mi">3</span><span class="c1">#characteristic mass</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">L0</span>
<span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">rho</span><span class="o">/</span><span class="n">M0</span><span class="o">*</span><span class="n">L0</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="n">cs</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span><span class="p">,</span> <span class="n">cl</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span>
<span class="n">omega</span> <span class="o">=</span> <span class="n">omega</span><span class="o">*</span><span class="n">T0</span>
<span class="n">wavenumber</span> <span class="o">=</span> <span class="n">wavenumber</span><span class="o">*</span><span class="n">L0</span>
<span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">cs</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappas</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="n">cl</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappal</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="c1">#complex celerities (core)</span>

<span class="c1">##################################</span>
<span class="c1"># Create mesh and finite elements (six-node triangles with three dofs per node for the three components of displacement)</span>
<span class="n">mesh</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">create_rectangle</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="o">-</span><span class="n">a</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">])],</span> 
                               <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="p">],</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">CellType</span><span class="o">.</span><span class="n">triangle</span><span class="p">)</span>
<span class="n">element</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">VectorElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="s2">&quot;triangle&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="c1">#Lagrange element, triangle, quadratic &quot;P2&quot;, 3D vector</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Create Material properties (isotropic)</span>
<span class="k">def</span> <span class="nf">isotropic_law</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span><span class="p">):</span>
    <span class="n">E</span><span class="p">,</span> <span class="n">nu</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">C11</span> <span class="o">=</span> <span class="n">C22</span> <span class="o">=</span> <span class="n">C33</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">nu</span><span class="p">)</span>
    <span class="n">C12</span> <span class="o">=</span> <span class="n">C13</span> <span class="o">=</span> <span class="n">C23</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="n">nu</span>
    <span class="n">C44</span> <span class="o">=</span> <span class="n">C55</span> <span class="o">=</span> <span class="n">C66</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">C11</span><span class="p">,</span><span class="n">C12</span><span class="p">,</span><span class="n">C13</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> 
            <span class="p">(</span><span class="n">C12</span><span class="p">,</span><span class="n">C22</span><span class="p">,</span><span class="n">C23</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> 
            <span class="p">(</span><span class="n">C13</span><span class="p">,</span><span class="n">C23</span><span class="p">,</span><span class="n">C33</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> 
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C44</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> 
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C55</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> 
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C66</span><span class="p">))</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">isotropic_law</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span><span class="p">)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ScalarType</span><span class="p">(</span><span class="n">C</span><span class="p">))</span>

<span class="c1">##################################</span>
<span class="c1"># Create free boundary conditions (or uncomment lines below for Dirichlet)</span>
<span class="n">bcs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1"># Dirichlet test case:</span>
<span class="c1">#fdim = mesh.topology.dim - 1</span>
<span class="c1">#boundary_facets = dolfinx.mesh.locate_entities_boundary(mesh, dim=fdim, marker=lambda x: np.logical_or(np.isclose(x[0], -a),</span>
<span class="c1">#                                                                                                       np.isclose(x[0], +a)+</span>
<span class="c1">#                                                                                                       np.isclose(x[1], -a)+</span>
<span class="c1">#                                                                                                       np.isclose(x[1], +a)))</span>
<span class="c1">#boundary_dofs = dolfinx.fem.locate_dofs_topological(V=V, entity_dim=fdim, entities=boundary_facets)</span>
<span class="c1">#bcs = [dolfinx.fem.dirichletbc(value=np.zeros(3, dtype=PETSc.ScalarType), dofs=boundary_dofs, V=V)]</span>

<span class="c1">##################################</span>
<span class="c1"># Define variational problem (SAFE method)</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TrialFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TestFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">Lxy</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)])</span>
<span class="n">Lz</span>  <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">k1</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lxy</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lxy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k1_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span>
<span class="n">k2</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lxy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k2_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span>
<span class="n">k3</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lz</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k3_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k3</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">mass_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Build PETSc matrices</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">mass_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">M</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K0</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k1_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">)</span>
<span class="n">K0</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K1</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k2_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">K1</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K2</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k3_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">K2</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Solve the eigenproblem with SLEPc\</span>
<span class="c1"># The parameter is k, the eigenvalue is omega**2</span>
<span class="n">wg</span> <span class="o">=</span> <span class="n">Waveguide</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">K0</span><span class="p">,</span> <span class="n">K1</span><span class="p">,</span> <span class="n">K2</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">wavenumber</span><span class="o">=</span><span class="n">wavenumber</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">nev</span><span class="p">)</span> <span class="c1">#access to components with: wg.eigenvalues[ik][imode], wg.eigenvectors[ik][idof,imode]</span>
<span class="n">wg</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Comparison with Euler-Bernoulli analytical solutions</span>
<span class="n">k</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">wavenumber</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Computed eigenvalues for the first wavenumber (k=</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">):</span><span class="se">\n</span><span class="s1"> </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">eigenvalues</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">E</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">Ip</span><span class="p">,</span> <span class="n">S</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">rho</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">4</span><span class="o">/</span><span class="mi">12</span><span class="p">,</span> <span class="mf">0.1406</span><span class="o">*</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="c1">#0.1406 is for square section</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Euler-Bernoulli beam solution (only accurate for low frequency):</span><span class="se">\n</span><span class="s1"> </span><span class="se">\</span>
<span class="s1">        Bending wave: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">E</span><span class="o">*</span><span class="n">I</span><span class="o">/</span><span class="n">rho</span><span class="o">/</span><span class="n">S</span><span class="o">*</span><span class="n">k</span><span class="o">**</span><span class="mi">4</span><span class="p">),</span><span class="n">decimals</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1"> </span><span class="se">\</span>
<span class="s1">        Torsional wave: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mu</span><span class="o">*</span><span class="n">Ip</span><span class="o">/</span><span class="n">rho</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span><span class="n">decimals</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1"> </span><span class="se">\</span>
<span class="s1">        Longitudinal wave: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">E</span><span class="o">/</span><span class="n">rho</span><span class="o">*</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span><span class="n">decimals</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Solve the eigenproblem with SLEPc\</span>
<span class="c1"># The parameter is omega, the eigenvalue is k</span>
<span class="n">wg</span> <span class="o">=</span> <span class="n">Waveguide</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">K0</span><span class="p">,</span> <span class="n">K1</span><span class="p">,</span> <span class="n">K2</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">omega</span><span class="o">=</span><span class="n">omega</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">nev</span><span class="p">)</span> <span class="c1">#access to components with: wg.eigenvalues[ik][imode], wg.eigenvectors[ik][idof,imode]</span>
<span class="n">wg</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span> <span class="c1">#blocking</span>

<span class="c1">##################################</span>
<span class="c1"># Comparison with Euler-Bernoulli analytical solutions</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">omega</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Computed eigenvalues for the first frequency (omega=</span><span class="si">{</span><span class="n">w</span><span class="si">}</span><span class="s1">):</span><span class="se">\n</span><span class="s1"> </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">eigenvalues</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">decimals</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Euler-Bernoulli beam solution (only accurate for low frequency):</span><span class="se">\n</span><span class="s1"> </span><span class="se">\</span>
<span class="s1">        Bending wave: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rho</span><span class="o">*</span><span class="n">S</span><span class="o">/</span><span class="n">E</span><span class="o">/</span><span class="n">I</span><span class="o">*</span><span class="n">w</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span><span class="n">decimals</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1"> </span><span class="se">\</span>
<span class="s1">        Torsional wave: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rho</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">I</span><span class="o">/</span><span class="n">mu</span><span class="o">/</span><span class="n">Ip</span><span class="o">*</span><span class="n">w</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span><span class="n">decimals</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1"> </span><span class="se">\</span>
<span class="s1">        Longitudinal wave: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rho</span><span class="o">/</span><span class="n">E</span><span class="o">*</span><span class="n">w</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span><span class="n">decimals</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Mesh visualization</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span><span class="p">))</span>
<span class="n">plotter</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">Plotter</span><span class="p">()</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">view_xy</span><span class="p">()</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Mode shape visualization</span>
<span class="n">ik</span><span class="p">,</span> <span class="n">imode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span> <span class="c1">#parameter index, mode index to visualize</span>
<span class="n">vec</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">eigenvectors</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span><span class="o">.</span><span class="n">getColumnVector</span><span class="p">(</span><span class="n">imode</span><span class="p">)</span>
<span class="n">u_grid</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">V</span><span class="p">))</span>
<span class="n">u_grid</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="o">/</span><span class="n">V</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">value_shape</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">value_shape</span><span class="p">))</span> <span class="c1">#V.element.value_shape is equal to 3</span>
<span class="n">u_plotter</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">Plotter</span><span class="p">()</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;wireframe&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span> <span class="c1">#FE mesh</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">u_grid</span><span class="o">.</span><span class="n">warp_by_vector</span><span class="p">(</span><span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">2.0</span><span class="p">),</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">show_scalar_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1">#do not show edges of higher order elements with pyvista</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">show_axes</span><span class="p">()</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="s2">&quot;&quot;</span>

</pre></div>
</div>
</section>
<section id="elastic-waveguide-squarebar3d-parallelizedloop-py">
<h2>Elastic_Waveguide_SquareBar3D_ParallelizedLoop.py<a class="headerlink" href="#elastic-waveguide-squarebar3d-parallelizedloop-py" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This file is a tutorial for waveguicsx (*), whose inputs are</span>
<span class="c1"># the matrices K0, K1, K2, M and the excitation vector F.</span>
<span class="c1"># In the tutorial, K0, K1, K2 and M are finite element matrices generated by FEnicSX (**).</span>
<span class="c1">#  (*) waveguicsx is a python library for solving complex waveguide problems</span>
<span class="c1">#      Copyright (C) 2023  Fabien Treyssede</span>
<span class="c1">#      waveguicsx is free software distributed under the GNU General Public License</span>
<span class="c1">#      (https://github.com/treyssede/waveguicsx)</span>
<span class="c1"># (**) FEniCSx is an open-source computing platform for solving partial differential equations</span>
<span class="c1">#      distributed under the GNU Lesser General Public License (https://fenicsproject.org/)</span>

<span class="c1">##################################</span>
<span class="c1"># 3D (visco-)elastic waveguide example\</span>
<span class="c1"># The cross-section is a 2D square with free boundary conditions on its 1D boundaries\</span>
<span class="c1"># material: viscoelastic steel\</span>
<span class="c1"># The waveguide FE formulation (SAFE) leads to the following eigenvalue problem:\</span>
<span class="c1"># $(\textbf{K}_1-\omega^2\textbf{M}+\text{i}k(\textbf{K}_2+\textbf{K}_2^\text{T})+k^2\textbf{K}_3)\textbf{U}=\textbf{0}$\</span>
<span class="c1"># Viscoelastic loss is included by introducing imaginary parts (negative) to wave celerities\</span>
<span class="c1"># In this example:</span>
<span class="c1"># - the parameter loop (here, the frequency loop) is distributed on all processes</span>
<span class="c1"># - FE mesh and matrices are (therefore) built on each local process</span>
<span class="c1"># Reminder for an execution in parallel mode (e.g. 4 processes):</span>
<span class="c1">#  mpiexec -n 4 python3 Elastic_Waveguide_SquareBar3D_ParallelizedLoop.py</span>

<span class="kn">import</span> <span class="nn">dolfinx</span>
<span class="kn">import</span> <span class="nn">ufl</span>
<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">from</span> <span class="nn">petsc4py</span> <span class="kn">import</span> <span class="n">PETSc</span>
<span class="kn">from</span> <span class="nn">slepc4py</span> <span class="kn">import</span> <span class="n">SLEPc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="c1">#import pyvista</span>

<span class="kn">from</span> <span class="nn">waveguicsx.waveguide</span> <span class="kn">import</span> <span class="n">Waveguide</span>
<span class="c1">#For proper use with a jupyter notebook, uncomment the following line:</span>
<span class="c1">#pyvista.set_jupyter_backend(&quot;none&quot;); pyvista.start_xvfb() #try also: &quot;static&quot;, &quot;pythreejs&quot;, &quot;ipyvtklink&quot;...</span>

<span class="c1">##################################</span>
<span class="c1"># Input parameters</span>
<span class="n">a</span> <span class="o">=</span> <span class="mf">2.7e-3</span> <span class="c1">#core half-length (m)</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1">#number of finite elements along one half-side</span>
<span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="mi">7932</span><span class="p">,</span> <span class="mi">3260</span><span class="p">,</span> <span class="mi">5960</span> <span class="c1">#core density (kg/m3), shear and longitudinal wave celerities (m/s)</span>
<span class="n">kappas</span><span class="p">,</span> <span class="n">kappal</span> <span class="o">=</span> <span class="mf">0.008</span><span class="p">,</span> <span class="mf">0.003</span> <span class="c1">#core shear and longitudinal bulk wave attenuations (Np/wavelength)</span>
<span class="n">omega</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">500e3</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="mf">500e3</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span> <span class="c1">#angular frequency range (rad/s)</span>
<span class="n">nev</span> <span class="o">=</span> <span class="mi">20</span> <span class="c1">#number of eigenvalues</span>

<span class="c1">##################################</span>
<span class="c1"># Re-scaling</span>
<span class="n">L0</span> <span class="o">=</span> <span class="n">a</span> <span class="c1">#characteristic length</span>
<span class="n">T0</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">cs</span> <span class="c1">#characteristic time</span>
<span class="n">M0</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">a</span><span class="o">**</span><span class="mi">3</span><span class="c1">#characteristic mass</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">L0</span>
<span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">rho</span><span class="o">/</span><span class="n">M0</span><span class="o">*</span><span class="n">L0</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="n">cs</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span><span class="p">,</span> <span class="n">cl</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span>
<span class="n">omega</span> <span class="o">=</span> <span class="n">omega</span><span class="o">*</span><span class="n">T0</span>
<span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">cs</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappas</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="n">cl</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappal</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="c1">#complex celerities (core)</span>

<span class="c1">##################################</span>
<span class="c1"># Create mesh and finite elements (six-node triangles with three dofs per node for the three components of displacement)</span>
<span class="n">mesh</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">create_rectangle</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_SELF</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="o">-</span><span class="n">a</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">])],</span> 
                               <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="p">],</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">CellType</span><span class="o">.</span><span class="n">triangle</span><span class="p">)</span> <span class="c1">#MPI.COMM_SELF = FE mesh is built on each local process</span>
<span class="n">element</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">VectorElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="s2">&quot;triangle&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="c1">#Lagrange element, triangle, quadratic &quot;P2&quot;, 3D vector</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Create Material properties (isotropic)</span>
<span class="k">def</span> <span class="nf">isotropic_law</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span><span class="p">):</span>
    <span class="n">E</span><span class="p">,</span> <span class="n">nu</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">C11</span> <span class="o">=</span> <span class="n">C22</span> <span class="o">=</span> <span class="n">C33</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">nu</span><span class="p">)</span>
    <span class="n">C12</span> <span class="o">=</span> <span class="n">C13</span> <span class="o">=</span> <span class="n">C23</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="n">nu</span>
    <span class="n">C44</span> <span class="o">=</span> <span class="n">C55</span> <span class="o">=</span> <span class="n">C66</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">C11</span><span class="p">,</span><span class="n">C12</span><span class="p">,</span><span class="n">C13</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> 
            <span class="p">(</span><span class="n">C12</span><span class="p">,</span><span class="n">C22</span><span class="p">,</span><span class="n">C23</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> 
            <span class="p">(</span><span class="n">C13</span><span class="p">,</span><span class="n">C23</span><span class="p">,</span><span class="n">C33</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> 
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C44</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> 
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C55</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> 
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C66</span><span class="p">))</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">isotropic_law</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span><span class="p">)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ScalarType</span><span class="p">(</span><span class="n">C</span><span class="p">))</span>

<span class="c1">##################################</span>
<span class="c1"># Create free boundary conditions</span>
<span class="n">bcs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1">##################################</span>
<span class="c1"># Define variational problem (SAFE method)</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TrialFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TestFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">Lxy</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)])</span>
<span class="n">Lz</span>  <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">k1</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lxy</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lxy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k1_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span>
<span class="n">k2</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lxy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k2_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span>
<span class="n">k3</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lz</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k3_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k3</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">mass_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Build PETSc matrices</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">mass_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">M</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K0</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k1_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">)</span>
<span class="n">K0</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K1</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k2_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">K1</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K2</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k3_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">K2</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Solve the eigenproblem with SLEPc\</span>
<span class="c1"># The parameter is k, the eigenvalue is omega**2</span>
<span class="c1"># The parameter loop is parallelized</span>
<span class="c1"># Parallelization</span>
<span class="n">comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span> <span class="c1">#use all processes for the loop</span>
<span class="n">size</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>  <span class="c1">#number of processors</span>
<span class="n">rank</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>  <span class="c1">#returns the rank of the process that called it within comm_world</span>
<span class="c1"># Split the parameter range and scatter to all</span>
<span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#define on rank 0 only</span>
    <span class="n">param_split</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">omega</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="c1">#split param in blocks of length size roughly</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">param_split</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">param_local</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">param_split</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#scatter 1 block per process</span>
<span class="c1"># Solve</span>
<span class="n">wg</span> <span class="o">=</span> <span class="n">Waveguide</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_SELF</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">K0</span><span class="p">,</span> <span class="n">K1</span><span class="p">,</span> <span class="n">K2</span><span class="p">)</span> <span class="c1">#MPI.COMM_SELF = SLEPc will used FE matrices on each local process</span>
<span class="n">wg</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">omega</span><span class="o">=</span><span class="n">param_local</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">nev</span><span class="p">)</span>
<span class="c1"># Some post-processing</span>
<span class="n">wg</span><span class="o">.</span><span class="n">compute_energy_velocity</span><span class="p">()</span>
<span class="n">wg</span><span class="o">.</span><span class="n">compute_traveling_direction</span><span class="p">()</span>
<span class="c1"># Gather</span>
<span class="n">wg</span><span class="o">.</span><span class="n">omega</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">reduce</span><span class="p">([</span><span class="n">wg</span><span class="o">.</span><span class="n">omega</span><span class="p">],</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#reduce works for lists: brackets are necessary (wg.omega is not a list but a numpy array)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">eigenvalues</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">eigenvalues</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">energy_velocity</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">energy_velocity</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">traveling_direction</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">traveling_direction</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="c1">#wg.eigenvectors = comm.reduce(wg.eigenvectors, op=MPI.SUM, root=0) #don&#39;t do this line: reduce cannot pickle &#39;petsc4py.PETSc.Vec&#39; objects (keep the mode shapes distributed on each processor rather than gather them)</span>
<span class="c1"># Plot results</span>
<span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">wg</span><span class="o">.</span><span class="n">omega</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">omega</span><span class="p">)</span> <span class="c1">#wg.omega is transformed to a numpy array for a proper use of wg.plot()</span>
    <span class="n">wg</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
    <span class="n">wg</span><span class="o">.</span><span class="n">plot_energy_velocity</span><span class="p">(</span><span class="n">direction</span><span class="o">=+</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1">#plt.savefig(&quot;Elastic_Waveguide_Bar3D_ParallelizedLoop.svg&quot;)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

</pre></div>
</div>
</section>
<section id="elastic-waveguide-squarebar3d-pml-py">
<h2>Elastic_Waveguide_SquareBar3D_PML.py<a class="headerlink" href="#elastic-waveguide-squarebar3d-pml-py" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This file is a tutorial for waveguicsx (*), whose inputs are</span>
<span class="c1"># the matrices K0, K1, K2, M and the excitation vector F.</span>
<span class="c1"># In the tutorial, K0, K1, K2 and M are finite element matrices generated by FEnicSX (**).</span>
<span class="c1">#  (*) waveguicsx is a python library for solving complex waveguide problems</span>
<span class="c1">#      Copyright (C) 2023  Fabien Treyssede</span>
<span class="c1">#      waveguicsx is free software distributed under the GNU General Public License</span>
<span class="c1">#      (https://github.com/treyssede/waveguicsx)</span>
<span class="c1"># (**) FEniCSx is an open-source computing platform for solving partial differential equations</span>
<span class="c1">#      distributed under the GNU Lesser General Public License (https://fenicsproject.org/)</span>

<span class="c1">##################################</span>
<span class="c1"># 3D (visco-)elastic waveguide example\</span>
<span class="c1"># The cross-section is a 2D square buried into a PML external elastic medium\</span>
<span class="c1"># material: viscoelastic steel into cement grout\</span>
<span class="c1"># The waveguide FE formulation (SAFE) leads to the following eigenvalue problem:\</span>
<span class="c1"># $(\textbf{K}_1-\omega^2\textbf{M}+\text{i}k(\textbf{K}_2+\textbf{K}_2^\text{T})+k^2\textbf{K}_3)\textbf{U}=\textbf{0}$\</span>
<span class="c1"># Viscoelastic loss is included by introducing imaginary parts (negative) to wave celerities\</span>
<span class="c1"># The PML has a parabolic profile</span>
<span class="c1"># Results are to be compared with Fig. 8 of paper: Treyssede, Journal of Computational Physics 314 (2016), 341–354</span>

<span class="kn">import</span> <span class="nn">dolfinx</span>
<span class="kn">import</span> <span class="nn">ufl</span>
<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">from</span> <span class="nn">petsc4py</span> <span class="kn">import</span> <span class="n">PETSc</span>
<span class="kn">from</span> <span class="nn">slepc4py</span> <span class="kn">import</span> <span class="n">SLEPc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pyvista</span>

<span class="kn">from</span> <span class="nn">waveguicsx.waveguide</span> <span class="kn">import</span> <span class="n">Waveguide</span>
<span class="c1">#For proper use with a jupyter notebook, uncomment the following line:</span>
<span class="c1">#pyvista.set_jupyter_backend(&quot;none&quot;); pyvista.start_xvfb() #try also: &quot;static&quot;, &quot;pythreejs&quot;, &quot;ipyvtklink&quot;...</span>

<span class="c1">##################################</span>
<span class="c1"># Input parameters</span>
<span class="n">a</span> <span class="o">=</span> <span class="mf">2.7e-3</span> <span class="c1">#core half-length (m)</span>
<span class="n">b</span> <span class="o">=</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">a</span> <span class="c1">#half-length including PML (m)</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">24</span> <span class="c1">#number of finite elements along one half-side</span>
<span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">N</span><span class="o">/</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;The ratio a/b*N must be an integer, please adjust N&quot;</span><span class="p">)</span>
<span class="n">rho_core</span><span class="p">,</span> <span class="n">cs_core</span><span class="p">,</span> <span class="n">cl_core</span> <span class="o">=</span> <span class="mi">7932</span><span class="p">,</span> <span class="mi">3260</span><span class="p">,</span> <span class="mi">5960</span> <span class="c1">#core density (kg/m3), shear and longitudinal wave celerities (m/s)</span>
<span class="n">kappas_core</span><span class="p">,</span> <span class="n">kappal_core</span> <span class="o">=</span> <span class="mf">0.008</span><span class="p">,</span> <span class="mf">0.003</span> <span class="c1">#core shear and longitudinal bulk wave attenuations (Np/wavelength)</span>
<span class="n">rho_ext</span><span class="p">,</span> <span class="n">cs_ext</span><span class="p">,</span> <span class="n">cl_ext</span> <span class="o">=</span> <span class="mi">1600</span><span class="p">,</span> <span class="mi">1700</span><span class="p">,</span> <span class="mi">2810</span> <span class="c1">#for the external medium</span>
<span class="n">kappas_ext</span><span class="p">,</span> <span class="n">kappal_ext</span> <span class="o">=</span> <span class="mf">0.100</span><span class="p">,</span> <span class="mf">0.043</span> <span class="c1">#for the external medium</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mi">2</span><span class="o">+</span><span class="mi">4</span><span class="n">j</span> <span class="c1">#average value of the absorbing function inside the PML</span>
<span class="n">omega</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">26e6</span><span class="o">/</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="mf">1e3</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span> <span class="c1">#angular frequencies (rad/s)</span>
<span class="n">nev</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1">#number of eigenvalues</span>
<span class="n">target</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">omega</span><span class="p">:</span> <span class="n">omega</span><span class="o">/</span><span class="n">cl_core</span><span class="o">.</span><span class="n">real</span> <span class="c1">#target set at the longitudinal wavenumber of core to find L(0,n) modes</span>

<span class="c1">##################################</span>
<span class="c1"># Re-scaling</span>
<span class="n">L0</span> <span class="o">=</span> <span class="n">a</span> <span class="c1">#characteristic length</span>
<span class="n">T0</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">cs_core</span> <span class="c1">#characteristic time</span>
<span class="n">M0</span> <span class="o">=</span> <span class="n">rho_core</span><span class="o">*</span><span class="n">a</span><span class="o">**</span><span class="mi">3</span><span class="c1">#characteristic mass</span>
<span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">L0</span><span class="p">,</span> <span class="n">b</span><span class="o">/</span><span class="n">L0</span>
<span class="n">rho_core</span><span class="p">,</span> <span class="n">cs_core</span><span class="p">,</span> <span class="n">cl_core</span> <span class="o">=</span> <span class="n">rho_core</span><span class="o">/</span><span class="n">M0</span><span class="o">*</span><span class="n">L0</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="n">cs_core</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span><span class="p">,</span> <span class="n">cl_core</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span>
<span class="n">rho_ext</span><span class="p">,</span> <span class="n">cs_ext</span><span class="p">,</span> <span class="n">cl_ext</span> <span class="o">=</span> <span class="n">rho_ext</span><span class="o">/</span><span class="n">M0</span><span class="o">*</span><span class="n">L0</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="n">cs_ext</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span><span class="p">,</span> <span class="n">cl_ext</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span>
<span class="n">omega</span> <span class="o">=</span> <span class="n">omega</span><span class="o">*</span><span class="n">T0</span>
<span class="n">cs_core</span><span class="p">,</span> <span class="n">cl_core</span> <span class="o">=</span> <span class="n">cs_core</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappas_core</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="n">cl_core</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappal_core</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="c1">#complex celerities (core)</span>
<span class="n">cs_ext</span><span class="p">,</span> <span class="n">cl_ext</span> <span class="o">=</span> <span class="n">cs_ext</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappas_ext</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="n">cl_ext</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappal_ext</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="c1">#complex celerities (exterior)</span>

<span class="c1">##################################</span>
<span class="c1"># Create mesh and finite elements (P2 quadrilaterals with three dofs per node for the three components of displacement)</span>
<span class="n">mesh</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">create_rectangle</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">b</span><span class="p">,</span> <span class="o">-</span><span class="n">b</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">b</span><span class="p">,</span> <span class="n">b</span><span class="p">])],</span> 
                               <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="p">],</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">CellType</span><span class="o">.</span><span class="n">quadrilateral</span><span class="p">)</span>
<span class="n">element</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">VectorElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="s2">&quot;quadrilateral&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="c1">#Lagrange element, quadrilateral, quadratic &quot;P2&quot;, 3D vector</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Create Material properties, discontinuous between core and exterior</span>
<span class="k">def</span> <span class="nf">isotropic_law</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span><span class="p">):</span>
    <span class="n">E</span><span class="p">,</span> <span class="n">nu</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">C11</span> <span class="o">=</span> <span class="n">C22</span> <span class="o">=</span> <span class="n">C33</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">nu</span><span class="p">)</span>
    <span class="n">C12</span> <span class="o">=</span> <span class="n">C13</span> <span class="o">=</span> <span class="n">C23</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="n">nu</span>
    <span class="n">C44</span> <span class="o">=</span> <span class="n">C55</span> <span class="o">=</span> <span class="n">C66</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">C11</span><span class="p">,</span><span class="n">C12</span><span class="p">,</span><span class="n">C13</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="n">C12</span><span class="p">,</span><span class="n">C22</span><span class="p">,</span><span class="n">C23</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="n">C13</span><span class="p">,</span><span class="n">C23</span><span class="p">,</span><span class="n">C33</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C44</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C55</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C66</span><span class="p">]])</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span> <span class="c1">#the upper-triangle part of C (21 elements only)...</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">15</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">36</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#... stored as a column vector completed with zeros up to 36 elements (error otherwise)</span>
    <span class="k">return</span> <span class="n">C</span>
<span class="n">C_core</span> <span class="o">=</span> <span class="n">isotropic_law</span><span class="p">(</span><span class="n">rho_core</span><span class="p">,</span> <span class="n">cs_core</span><span class="p">,</span> <span class="n">cl_core</span><span class="p">)</span>
<span class="n">C_ext</span> <span class="o">=</span> <span class="n">isotropic_law</span><span class="p">(</span><span class="n">rho_ext</span><span class="p">,</span> <span class="n">cs_ext</span><span class="p">,</span> <span class="n">cl_ext</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">eval_C</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">C_core</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&lt;=</span><span class="n">a</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&lt;=</span><span class="n">a</span><span class="p">)</span> \
           <span class="o">+</span> <span class="n">C_ext</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;=</span><span class="n">a</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&gt;=</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">values</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TensorElement</span><span class="p">(</span><span class="s2">&quot;DG&quot;</span><span class="p">,</span> <span class="s2">&quot;quadrilateral&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">symmetry</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="c1">#symmetry enables to store 21 elements instead of 36</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
<span class="n">C</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">eval_C</span><span class="p">)</span> <span class="c1">#C.vector.getSize()) should be equal to number of cells x 21</span>
<span class="c1"># Same approach for density</span>
<span class="k">def</span> <span class="nf">eval_rho</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">rho_core</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&lt;=</span><span class="n">a</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&lt;=</span><span class="n">a</span><span class="p">)</span> \
           <span class="o">+</span> <span class="n">rho_ext</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;=</span><span class="n">a</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&gt;=</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">values</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;DG&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">rho</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
<span class="n">rho</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">eval_rho</span><span class="p">)</span>
<span class="c1"># Vizualization</span>
<span class="n">plotter</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">Plotter</span><span class="p">(</span><span class="n">window_size</span><span class="o">=</span><span class="p">[</span><span class="mi">600</span><span class="p">,</span> <span class="mi">400</span><span class="p">])</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span><span class="p">))</span>
<span class="n">grid</span><span class="o">.</span><span class="n">cell_data</span><span class="p">[</span><span class="s2">&quot;Cij&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">21</span><span class="p">]</span><span class="o">.</span><span class="n">real</span> <span class="c1">#index from 0 to 20, 0 being for C11...</span>
<span class="c1">#grid.cell_data[&quot;Cij&quot;] = rho.x.array.real #for checking density</span>
<span class="n">grid</span><span class="o">.</span><span class="n">set_active_scalars</span><span class="p">(</span><span class="s2">&quot;Cij&quot;</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_scalar_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="s1">&#39;Re(Cij)&#39;</span><span class="p">,</span> <span class="s1">&#39;upper_edge&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">view_xy</span><span class="p">()</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Create Cartesian PML functions, continuous</span>
<span class="k">def</span> <span class="nf">eval_gamma</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="c1">#pml profile: continuous and parabolic</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">alpha</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;=</span><span class="n">a</span><span class="p">),</span> <span class="c1">#gammax</span>
              <span class="mi">1</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">alpha</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&gt;=</span><span class="n">a</span><span class="p">)]</span> <span class="c1">#gammay</span>
    <span class="k">return</span> <span class="n">values</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">ufl</span><span class="o">.</span><span class="n">VectorElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="s2">&quot;quadrilateral&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">gamma</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
<span class="n">gamma</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">eval_gamma</span><span class="p">)</span>
<span class="c1"># Vizualization</span>
<span class="n">plotter</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">Plotter</span><span class="p">(</span><span class="n">window_size</span><span class="o">=</span><span class="p">[</span><span class="mi">800</span><span class="p">,</span> <span class="mi">400</span><span class="p">],</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">gridx</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">Q</span><span class="p">))</span>
<span class="n">gridx</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s2">&quot;gammax&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span>
<span class="n">gridx</span><span class="o">.</span><span class="n">set_active_scalars</span><span class="p">(</span><span class="s2">&quot;gammax&quot;</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;wireframe&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span> <span class="c1">#FE mesh</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">gridx</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">show_scalar_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="s1">&#39;Im(gammax)&#39;</span><span class="p">,</span> <span class="s1">&#39;upper_edge&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">view_xy</span><span class="p">()</span>
<span class="n">gridy</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">Q</span><span class="p">))</span>
<span class="n">gridy</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s2">&quot;gammay&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span>
<span class="n">gridy</span><span class="o">.</span><span class="n">set_active_scalars</span><span class="p">(</span><span class="s2">&quot;gammay&quot;</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;wireframe&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span> <span class="c1">#FE mesh</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">gridy</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">show_scalar_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="s1">&#39;Im(gammay)&#39;</span><span class="p">,</span> <span class="s1">&#39;upper_edge&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">view_xy</span><span class="p">()</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Create free boundary conditions (or uncomment lines below for Dirichlet)</span>
<span class="c1"># bcs = []</span>
<span class="c1"># Dirichlet test case:</span>
<span class="n">fdim</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">boundary_facets</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">locate_entities_boundary</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="n">fdim</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">b</span><span class="p">),</span>
                                                                                                       <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">+</span><span class="n">b</span><span class="p">)</span><span class="o">+</span>
                                                                                                       <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="n">b</span><span class="p">)</span><span class="o">+</span>
                                                                                                       <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">+</span><span class="n">b</span><span class="p">)))</span>
<span class="n">boundary_dofs</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">locate_dofs_topological</span><span class="p">(</span><span class="n">V</span><span class="o">=</span><span class="n">V</span><span class="p">,</span> <span class="n">entity_dim</span><span class="o">=</span><span class="n">fdim</span><span class="p">,</span> <span class="n">entities</span><span class="o">=</span><span class="n">boundary_facets</span><span class="p">)</span>
<span class="n">bcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">dirichletbc</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">PETSc</span><span class="o">.</span><span class="n">ScalarType</span><span class="p">),</span> <span class="n">dofs</span><span class="o">=</span><span class="n">boundary_dofs</span><span class="p">,</span> <span class="n">V</span><span class="o">=</span><span class="n">V</span><span class="p">)]</span>

<span class="c1">##################################</span>
<span class="c1"># Define variational problem (SAFE method)</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TrialFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TestFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">Lx</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">Ly</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)])</span>
<span class="n">Lz</span>  <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">gammax</span> <span class="o">=</span> <span class="n">gamma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">gammay</span> <span class="o">=</span> <span class="n">gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">k1</span> <span class="o">=</span> <span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="p">(</span><span class="n">gammay</span><span class="o">/</span><span class="n">gammax</span><span class="o">*</span><span class="n">Lx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">+</span><span class="n">Ly</span><span class="p">(</span><span class="n">u</span><span class="p">)),</span> <span class="n">Lx</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">+</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="p">(</span><span class="n">Lx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">+</span><span class="n">gammax</span><span class="o">/</span><span class="n">gammay</span><span class="o">*</span><span class="n">Ly</span><span class="p">(</span><span class="n">u</span><span class="p">)),</span> <span class="n">Ly</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k1_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span>
<span class="n">k2</span> <span class="o">=</span> <span class="p">(</span><span class="n">gammay</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lx</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="o">+</span><span class="n">gammax</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Ly</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k2_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span>
<span class="n">k3</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lz</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">gammax</span> <span class="o">*</span> <span class="n">gammay</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k3_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k3</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">gammax</span> <span class="o">*</span> <span class="n">gammay</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">mass_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Build PETSc matrices</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">mass_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">M</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K0</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k1_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">)</span>
<span class="n">K0</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K1</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k2_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">K1</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K2</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k3_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">K2</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Solve the eigenproblem with SLEPc\</span>
<span class="c1"># The parameter is omega, the eigenvalue is k</span>
<span class="n">wg</span> <span class="o">=</span> <span class="n">Waveguide</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">K0</span><span class="p">,</span> <span class="n">K1</span><span class="p">,</span> <span class="n">K2</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">omega</span><span class="o">=</span><span class="n">omega</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">evp</span><span class="o">.</span><span class="n">setWhichEigenpairs</span><span class="p">(</span><span class="n">SLEPc</span><span class="o">.</span><span class="n">PEP</span><span class="o">.</span><span class="n">Which</span><span class="o">.</span><span class="n">TARGET_MAGNITUDE</span><span class="p">)</span> <span class="c1">#here, preferred to TARGET_IMAGINARY</span>
<span class="n">wg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">nev</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Plot dispersion curves\</span>
<span class="c1"># Results are to be compared with Fig. 8 of Treyssede, Journal of Computational Physics 314 (2016), 341–354</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">plot_energy_velocity</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">26e3</span><span class="o">/</span><span class="mi">3260</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6000</span><span class="o">/</span><span class="mi">3260</span><span class="p">])</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">plot_attenuation</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">26e3</span><span class="o">/</span><span class="mi">3260</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2000</span><span class="o">/</span><span class="p">(</span><span class="mf">8.686</span><span class="o">*</span><span class="mi">1000</span><span class="p">)])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1">#wg.plot_spectrum(index=0)</span>
<span class="c1">#plt.show()</span>

<span class="c1">##################################</span>
<span class="c1"># Mode shape visualization</span>
<span class="n">ik</span><span class="p">,</span> <span class="n">imode</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">1</span> <span class="c1">#parameter index, mode index to visualize</span>
<span class="n">vec</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">eigenvectors</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span><span class="o">.</span><span class="n">getColumnVector</span><span class="p">(</span><span class="n">imode</span><span class="p">)</span>
<span class="n">u_grid</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">V</span><span class="p">))</span>
<span class="n">u_grid</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="o">/</span><span class="n">V</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">value_shape</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">value_shape</span><span class="p">))</span> <span class="c1">#V.element.value_shape is equal to 3</span>
<span class="n">u_plotter</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">Plotter</span><span class="p">()</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;wireframe&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span> <span class="c1">#FE mesh</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">u_grid</span><span class="o">.</span><span class="n">warp_by_vector</span><span class="p">(</span><span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">2.0</span><span class="p">),</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">show_scalar_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1">#do not show edges of higher order elements with pyvista</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">show_axes</span><span class="p">()</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="s2">&quot;&quot;</span>

</pre></div>
</div>
</section>
<section id="elastic-waveguide-squarebar3d-pml-gmsh-py">
<h2>Elastic_Waveguide_SquareBar3D_PML_Gmsh.py<a class="headerlink" href="#elastic-waveguide-squarebar3d-pml-gmsh-py" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This file is a tutorial for waveguicsx (*), whose inputs are</span>
<span class="c1"># the matrices K0, K1, K2, M and the excitation vector F.</span>
<span class="c1"># In the tutorial, K0, K1, K2 and M are finite element matrices generated by FEnicSX (**).</span>
<span class="c1">#  (*) waveguicsx is a python library for solving complex waveguide problems</span>
<span class="c1">#      Copyright (C) 2023  Fabien Treyssede</span>
<span class="c1">#      waveguicsx is free software distributed under the GNU General Public License</span>
<span class="c1">#      (https://github.com/treyssede/waveguicsx)</span>
<span class="c1"># (**) FEniCSx is an open-source computing platform for solving partial differential equations</span>
<span class="c1">#      distributed under the GNU Lesser General Public License (https://fenicsproject.org/)</span>

<span class="c1">##################################</span>
<span class="c1"># 3D (visco-)elastic waveguide example\</span>
<span class="c1"># The cross-section is a 2D square buried into a PML external elastic medium\</span>
<span class="c1"># material: viscoelastic steel into cement grout\</span>
<span class="c1"># The waveguide FE formulation (SAFE) leads to the following eigenvalue problem:\</span>
<span class="c1"># $(\textbf{K}_1-\omega^2\textbf{M}+\text{i}k(\textbf{K}_2+\textbf{K}_2^\text{T})+k^2\textbf{K}_3)\textbf{U}=\textbf{0}$\</span>
<span class="c1"># Viscoelastic loss is included by introducing imaginary parts (negative) to wave celerities\</span>
<span class="c1"># The PML has a parabolic profile\</span>
<span class="c1"># The FE mesh is built from Gmsh\</span>
<span class="c1"># Results are to be compared with Fig. 8 of paper: Treyssede, Journal of Computational Physics 314 (2016), 341–354</span>

<span class="kn">import</span> <span class="nn">gmsh</span> <span class="c1">#full documentation entirely defined in the `gmsh.py&#39; module</span>
<span class="kn">import</span> <span class="nn">dolfinx</span>
<span class="kn">import</span> <span class="nn">ufl</span>
<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">from</span> <span class="nn">petsc4py</span> <span class="kn">import</span> <span class="n">PETSc</span>
<span class="kn">from</span> <span class="nn">slepc4py</span> <span class="kn">import</span> <span class="n">SLEPc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pyvista</span>

<span class="kn">from</span> <span class="nn">waveguicsx.waveguide</span> <span class="kn">import</span> <span class="n">Waveguide</span>
<span class="c1">#For proper use with a jupyter notebook, uncomment the following line:</span>
<span class="c1">#pyvista.set_jupyter_backend(&quot;none&quot;); pyvista.start_xvfb() #try also: &quot;static&quot;, &quot;pythreejs&quot;, &quot;ipyvtklink&quot;...</span>

<span class="c1">##################################</span>
<span class="c1"># Input parameters</span>
<span class="n">a</span> <span class="o">=</span> <span class="mf">2.7e-3</span> <span class="c1">#core half-length (m)</span>
<span class="n">b</span><span class="p">,</span> <span class="n">le</span> <span class="o">=</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="o">/</span><span class="mi">16</span> <span class="c1">#half-length including PML (m), finite element characteristic length (m)</span>
<span class="n">rho_core</span><span class="p">,</span> <span class="n">cs_core</span><span class="p">,</span> <span class="n">cl_core</span> <span class="o">=</span> <span class="mi">7932</span><span class="p">,</span> <span class="mi">3260</span><span class="p">,</span> <span class="mi">5960</span> <span class="c1">#core density (kg/m3), shear and longitudinal wave celerities (m/s)</span>
<span class="n">kappas_core</span><span class="p">,</span> <span class="n">kappal_core</span> <span class="o">=</span> <span class="mf">0.008</span><span class="p">,</span> <span class="mf">0.003</span> <span class="c1">#core shear and longitudinal bulk wave attenuations (Np/wavelength)</span>
<span class="n">rho_ext</span><span class="p">,</span> <span class="n">cs_ext</span><span class="p">,</span> <span class="n">cl_ext</span> <span class="o">=</span> <span class="mi">1600</span><span class="p">,</span> <span class="mi">1700</span><span class="p">,</span> <span class="mi">2810</span> <span class="c1">#for the external medium</span>
<span class="n">kappas_ext</span><span class="p">,</span> <span class="n">kappal_ext</span> <span class="o">=</span> <span class="mf">0.100</span><span class="p">,</span> <span class="mf">0.043</span> <span class="c1">#for the external medium</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mi">2</span><span class="o">+</span><span class="mi">4</span><span class="n">j</span> <span class="c1">#average value of the absorbing function inside the PML</span>
<span class="n">omega</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">26e6</span><span class="o">/</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="mf">1e3</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span> <span class="c1">#angular frequencies (rad/s)</span>
<span class="n">nev</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1">#number of eigenvalues</span>
<span class="n">target</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">omega</span><span class="p">:</span> <span class="n">omega</span><span class="o">/</span><span class="n">cl_core</span><span class="o">.</span><span class="n">real</span> <span class="c1">#target set at the longitudinal wavenumber of core to find L(0,n) modes</span>

<span class="c1">##################################</span>
<span class="c1"># Re-scaling</span>
<span class="n">L0</span> <span class="o">=</span> <span class="n">a</span> <span class="c1">#characteristic length</span>
<span class="n">T0</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">cs_core</span> <span class="c1">#characteristic time</span>
<span class="n">M0</span> <span class="o">=</span> <span class="n">rho_core</span><span class="o">*</span><span class="n">a</span><span class="o">**</span><span class="mi">3</span><span class="c1">#characteristic mass</span>
<span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">le</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">L0</span><span class="p">,</span> <span class="n">b</span><span class="o">/</span><span class="n">L0</span><span class="p">,</span> <span class="n">le</span><span class="o">/</span><span class="n">L0</span>
<span class="n">rho_core</span><span class="p">,</span> <span class="n">cs_core</span><span class="p">,</span> <span class="n">cl_core</span> <span class="o">=</span> <span class="n">rho_core</span><span class="o">/</span><span class="n">M0</span><span class="o">*</span><span class="n">L0</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="n">cs_core</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span><span class="p">,</span> <span class="n">cl_core</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span>
<span class="n">rho_ext</span><span class="p">,</span> <span class="n">cs_ext</span><span class="p">,</span> <span class="n">cl_ext</span> <span class="o">=</span> <span class="n">rho_ext</span><span class="o">/</span><span class="n">M0</span><span class="o">*</span><span class="n">L0</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="n">cs_ext</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span><span class="p">,</span> <span class="n">cl_ext</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span>
<span class="n">omega</span> <span class="o">=</span> <span class="n">omega</span><span class="o">*</span><span class="n">T0</span>
<span class="n">cs_core</span><span class="p">,</span> <span class="n">cl_core</span> <span class="o">=</span> <span class="n">cs_core</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappas_core</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="n">cl_core</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappal_core</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="c1">#complex celerities (core)</span>
<span class="n">cs_ext</span><span class="p">,</span> <span class="n">cl_ext</span> <span class="o">=</span> <span class="n">cs_ext</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappas_ext</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="n">cl_ext</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappal_ext</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="c1">#complex celerities (exterior)</span>

<span class="c1">##################################</span>
<span class="c1"># Create mesh from Gmsh and finite elements (six-node triangles with three dofs per node for the three components of displacement)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
<span class="c1"># Core</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="o">+</span><span class="n">a</span><span class="p">,</span> <span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="o">+</span><span class="n">a</span><span class="p">,</span> <span class="o">+</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="o">+</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addCurveLoop</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">core</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPlaneSurface</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
<span class="c1"># External medium</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="o">+</span><span class="n">b</span><span class="p">,</span> <span class="o">-</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="o">+</span><span class="n">b</span><span class="p">,</span> <span class="o">+</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="p">,</span> <span class="o">+</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="p">,</span> <span class="o">-</span><span class="n">b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addLine</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addCurveLoop</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">exterior</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPlaneSurface</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="c1"># Physical groups</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span> <span class="c1">#the CAD entities must be synchronized with the Gmsh model</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addPhysicalGroup</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="n">core</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#2: for 2D (surface)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addPhysicalGroup</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="n">exterior</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#2: for 2D (surface)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addPhysicalGroup</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="mi">21</span><span class="p">)</span> <span class="c1">#1: for 1D (line)</span>
<span class="c1"># Generate mesh</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#generate a 2D mesh</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">setOrder</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#interpolation order for the geometry, here 2nd order</span>
<span class="c1"># From gmsh to fenicsx</span>
<span class="n">mesh</span><span class="p">,</span> <span class="n">cell_tags</span><span class="p">,</span> <span class="n">facet_tags</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">gmshio</span><span class="o">.</span><span class="n">model_to_mesh</span><span class="p">(</span><span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gdim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># # Reminder for save &amp; read</span>
<span class="c1"># gmsh.write(&quot;Elastic_Waveguide_Bar3D_Open.msh&quot;) #save to disk</span>
<span class="c1"># mesh, cell_tags, facet_tags = dolfinx.io.gmshio.read_from_msh(&quot;Elastic_Waveguide_Bar3D_Open.msh&quot;, MPI.COMM_WORLD, rank=0, gdim=2)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span> <span class="c1">#called when done using the Gmsh Python API</span>
<span class="c1"># Visualize FE mesh with pyvista</span>
<span class="n">Vmesh</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">ufl</span><span class="o">.</span><span class="n">FiniteElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="s2">&quot;triangle&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="c1">#order 1 is properly handled with pyvista</span>
<span class="n">plotter</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">Plotter</span><span class="p">()</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">Vmesh</span><span class="p">))</span>
<span class="n">grid</span><span class="o">.</span><span class="n">cell_data</span><span class="p">[</span><span class="s2">&quot;Marker&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_tags</span><span class="o">.</span><span class="n">values</span>
<span class="n">grid</span><span class="o">.</span><span class="n">set_active_scalars</span><span class="p">(</span><span class="s2">&quot;Marker&quot;</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">view_xy</span><span class="p">()</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1"># Finite element space</span>
<span class="n">element</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">VectorElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="s2">&quot;triangle&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="c1">#Lagrange element, triangle, quadratic &quot;P2&quot;, 3D vector</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Create Material properties, discontinuous between core and exterior</span>
<span class="k">def</span> <span class="nf">isotropic_law</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span><span class="p">):</span>
    <span class="n">E</span><span class="p">,</span> <span class="n">nu</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">C11</span> <span class="o">=</span> <span class="n">C22</span> <span class="o">=</span> <span class="n">C33</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">nu</span><span class="p">)</span>
    <span class="n">C12</span> <span class="o">=</span> <span class="n">C13</span> <span class="o">=</span> <span class="n">C23</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="n">nu</span>
    <span class="n">C44</span> <span class="o">=</span> <span class="n">C55</span> <span class="o">=</span> <span class="n">C66</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">C11</span><span class="p">,</span><span class="n">C12</span><span class="p">,</span><span class="n">C13</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="n">C12</span><span class="p">,</span><span class="n">C22</span><span class="p">,</span><span class="n">C23</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="n">C13</span><span class="p">,</span><span class="n">C23</span><span class="p">,</span><span class="n">C33</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C44</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C55</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C66</span><span class="p">]])</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="mi">6</span><span class="p">)]</span> <span class="c1">#the upper-triangle part of C (21 elements only)</span>
    <span class="k">return</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ScalarType</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
<span class="n">C_core</span> <span class="o">=</span> <span class="n">isotropic_law</span><span class="p">(</span><span class="n">rho_core</span><span class="p">,</span> <span class="n">cs_core</span><span class="p">,</span> <span class="n">cl_core</span><span class="p">)</span>
<span class="n">C_ext</span> <span class="o">=</span> <span class="n">isotropic_law</span><span class="p">(</span><span class="n">rho_ext</span><span class="p">,</span> <span class="n">cs_ext</span><span class="p">,</span> <span class="n">cl_ext</span><span class="p">)</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TensorElement</span><span class="p">(</span><span class="s2">&quot;DG&quot;</span><span class="p">,</span> <span class="s2">&quot;triangle&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">symmetry</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="c1">#symmetry enables to store 21 elements instead of 36</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
<span class="n">cells</span> <span class="o">=</span> <span class="n">cell_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#core (tag=1)</span>
<span class="n">C</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[[</span><span class="nb">range</span><span class="p">(</span><span class="mi">21</span><span class="o">*</span><span class="n">c</span><span class="p">,</span><span class="mi">21</span><span class="o">*</span><span class="n">c</span><span class="o">+</span><span class="mi">21</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">C_core</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
<span class="n">cells</span> <span class="o">=</span> <span class="n">cell_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#exterior (tag=2)</span>
<span class="n">C</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[[</span><span class="nb">range</span><span class="p">(</span><span class="mi">21</span><span class="o">*</span><span class="n">c</span><span class="p">,</span><span class="mi">21</span><span class="o">*</span><span class="n">c</span><span class="o">+</span><span class="mi">21</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">C_ext</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
<span class="c1"># Same approach for density</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;DG&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">rho</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
<span class="n">cells</span> <span class="o">=</span> <span class="n">cell_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#core (tag=1)</span>
<span class="n">rho</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">cells</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">rho_core</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">))</span>
<span class="n">cells</span> <span class="o">=</span> <span class="n">cell_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#exterior (tag=2)</span>
<span class="n">rho</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="n">cells</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">rho_ext</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">))</span>
<span class="c1"># Vizualization</span>
<span class="n">plotter</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">Plotter</span><span class="p">(</span><span class="n">window_size</span><span class="o">=</span><span class="p">[</span><span class="mi">600</span><span class="p">,</span> <span class="mi">400</span><span class="p">])</span>
<span class="n">gridC</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span><span class="p">))</span> <span class="c1">#or *dolfinx.plot.create_vtk_mesh(Vmesh)</span>
<span class="n">gridC</span><span class="o">.</span><span class="n">cell_data</span><span class="p">[</span><span class="s2">&quot;Cij&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">21</span><span class="p">]</span><span class="o">.</span><span class="n">real</span> <span class="c1">#index from 0 to 35, 0 being for C11...</span>
<span class="c1">#gridC.cell_data[&quot;Cij&quot;] = rho.x.array.real #for checking density</span>
<span class="n">gridC</span><span class="o">.</span><span class="n">set_active_scalars</span><span class="p">(</span><span class="s2">&quot;Cij&quot;</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;wireframe&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span> <span class="c1">#FE mesh (with vertices of order 1 elements only owing to pyvista) </span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">gridC</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">show_scalar_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="s1">&#39;Re(Cij)&#39;</span><span class="p">,</span> <span class="s1">&#39;upper_edge&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">view_xy</span><span class="p">()</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Create Cartesian PML functions, continuous</span>
<span class="k">def</span> <span class="nf">eval_gamma</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="c1">#pml profile: continuous and parabolic</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">alpha</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;=</span><span class="n">a</span><span class="p">),</span> <span class="c1">#gammax</span>
              <span class="mi">1</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">alpha</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&gt;=</span><span class="n">a</span><span class="p">)]</span> <span class="c1">#gammay</span>
    <span class="k">return</span> <span class="n">values</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">ufl</span><span class="o">.</span><span class="n">VectorElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="s2">&quot;triangle&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">gamma</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
<span class="n">gamma</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">eval_gamma</span><span class="p">)</span>
<span class="c1"># Vizualization</span>
<span class="n">plotter</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">Plotter</span><span class="p">(</span><span class="n">window_size</span><span class="o">=</span><span class="p">[</span><span class="mi">800</span><span class="p">,</span> <span class="mi">400</span><span class="p">],</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">gridx</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">Q</span><span class="p">))</span>
<span class="n">gridx</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s2">&quot;gammax&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span>
<span class="n">gridx</span><span class="o">.</span><span class="n">set_active_scalars</span><span class="p">(</span><span class="s2">&quot;gammax&quot;</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;wireframe&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span> <span class="c1">#FE mesh</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">gridx</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">show_scalar_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="s1">&#39;Im(gammax)&#39;</span><span class="p">,</span> <span class="s1">&#39;upper_edge&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">view_xy</span><span class="p">()</span>
<span class="n">gridy</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">Q</span><span class="p">))</span>
<span class="n">gridy</span><span class="o">.</span><span class="n">point_data</span><span class="p">[</span><span class="s2">&quot;gammay&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span>
<span class="n">gridy</span><span class="o">.</span><span class="n">set_active_scalars</span><span class="p">(</span><span class="s2">&quot;gammay&quot;</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;wireframe&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span> <span class="c1">#FE mesh</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">gridy</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">show_scalar_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_text</span><span class="p">(</span><span class="s1">&#39;Im(gammay)&#39;</span><span class="p">,</span> <span class="s1">&#39;upper_edge&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">view_xy</span><span class="p">()</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Create free boundary conditions (or uncomment lines below for Dirichlet)</span>
<span class="c1"># bcs = []</span>
<span class="c1"># Dirichlet test case:</span>
<span class="n">boundary_facets</span> <span class="o">=</span> <span class="n">facet_tags</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span> <span class="c1">#outer boundary (tag=21)</span>
<span class="n">boundary_dofs</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">locate_dofs_topological</span><span class="p">(</span><span class="n">V</span><span class="o">=</span><span class="n">V</span><span class="p">,</span> <span class="n">entity_dim</span><span class="o">=</span><span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">entities</span><span class="o">=</span><span class="n">boundary_facets</span><span class="p">)</span>
<span class="n">bcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">dirichletbc</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">PETSc</span><span class="o">.</span><span class="n">ScalarType</span><span class="p">),</span> <span class="n">dofs</span><span class="o">=</span><span class="n">boundary_dofs</span><span class="p">,</span> <span class="n">V</span><span class="o">=</span><span class="n">V</span><span class="p">)]</span>

<span class="c1">##################################</span>
<span class="c1"># Define variational problem (SAFE method)</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TrialFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TestFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">Lx</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">Ly</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)])</span>
<span class="n">Lz</span>  <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">gammax</span> <span class="o">=</span> <span class="n">gamma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">gammay</span> <span class="o">=</span> <span class="n">gamma</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">k1</span> <span class="o">=</span> <span class="p">(</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="p">(</span><span class="n">gammay</span><span class="o">/</span><span class="n">gammax</span><span class="o">*</span><span class="n">Lx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">+</span><span class="n">Ly</span><span class="p">(</span><span class="n">u</span><span class="p">)),</span> <span class="n">Lx</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">+</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="p">(</span><span class="n">Lx</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">+</span><span class="n">gammax</span><span class="o">/</span><span class="n">gammay</span><span class="o">*</span><span class="n">Ly</span><span class="p">(</span><span class="n">u</span><span class="p">)),</span> <span class="n">Ly</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k1_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span>
<span class="n">k2</span> <span class="o">=</span> <span class="p">(</span><span class="n">gammay</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lx</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="o">+</span><span class="n">gammax</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Ly</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k2_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span>
<span class="n">k3</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lz</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">gammax</span> <span class="o">*</span> <span class="n">gammay</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k3_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k3</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">gammax</span> <span class="o">*</span> <span class="n">gammay</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">mass_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Build PETSc matrices</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">mass_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">M</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K0</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k1_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">)</span>
<span class="n">K0</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K1</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k2_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">K1</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K2</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k3_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">K2</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Solve the eigenproblem with SLEPc\</span>
<span class="c1"># The parameter is omega, the eigenvalue is k</span>
<span class="n">wg</span> <span class="o">=</span> <span class="n">Waveguide</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">K0</span><span class="p">,</span> <span class="n">K1</span><span class="p">,</span> <span class="n">K2</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">omega</span><span class="o">=</span><span class="n">omega</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">evp</span><span class="o">.</span><span class="n">setWhichEigenpairs</span><span class="p">(</span><span class="n">SLEPc</span><span class="o">.</span><span class="n">PEP</span><span class="o">.</span><span class="n">Which</span><span class="o">.</span><span class="n">TARGET_MAGNITUDE</span><span class="p">)</span> <span class="c1">#here, preferred to TARGET_IMAGINARY</span>
<span class="n">wg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">nev</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Plot dispersion curves\</span>
<span class="c1"># Results are to be compared with Fig. 8 of Treyssede, Journal of Computational Physics 314 (2016), 341–354</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">plot_energy_velocity</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">26e3</span><span class="o">/</span><span class="mi">3260</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6000</span><span class="o">/</span><span class="mi">3260</span><span class="p">])</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">plot_attenuation</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mf">26e3</span><span class="o">/</span><span class="mi">3260</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2000</span><span class="o">/</span><span class="p">(</span><span class="mf">8.686</span><span class="o">*</span><span class="mi">1000</span><span class="p">)])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1">#wg.plot_spectrum(index=0)</span>
<span class="c1">#plt.show()</span>

<span class="c1">##################################</span>
<span class="c1"># Mode shape visualization</span>
<span class="n">ik</span><span class="p">,</span> <span class="n">imode</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">1</span> <span class="c1">#parameter index, mode index to visualize</span>
<span class="n">vec</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">eigenvectors</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span><span class="o">.</span><span class="n">getColumnVector</span><span class="p">(</span><span class="n">imode</span><span class="p">)</span>
<span class="n">u_grid</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">V</span><span class="p">))</span>
<span class="n">u_grid</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="o">/</span><span class="n">V</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">value_shape</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">value_shape</span><span class="p">))</span> <span class="c1">#V.element.value_shape is equal to 3</span>
<span class="n">u_plotter</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">Plotter</span><span class="p">()</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;wireframe&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span> <span class="c1">#FE mesh</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">u_grid</span><span class="o">.</span><span class="n">warp_by_vector</span><span class="p">(</span><span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">2.0</span><span class="p">),</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">show_scalar_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1">#do not show edges of higher order elements with pyvista</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">show_axes</span><span class="p">()</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

</pre></div>
</div>
</section>
<section id="elastic-waveguide-circularbar3d-forcedresponse-gmsh-py">
<h2>Elastic_Waveguide_CircularBar3D_ForcedResponse_Gmsh.py<a class="headerlink" href="#elastic-waveguide-circularbar3d-forcedresponse-gmsh-py" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This file is a tutorial for waveguicsx (*), whose inputs are</span>
<span class="c1"># the matrices K0, K1, K2, M and the excitation vector F.</span>
<span class="c1"># In the tutorial, K0, K1, K2 and M are finite element matrices generated by FEnicSX (**).</span>
<span class="c1">#  (*) waveguicsx is a python library for solving complex waveguide problems</span>
<span class="c1">#      Copyright (C) 2023  Fabien Treyssede</span>
<span class="c1">#      waveguicsx is free software distributed under the GNU General Public License</span>
<span class="c1">#      (https://github.com/treyssede/waveguicsx)</span>
<span class="c1"># (**) FEniCSx is an open-source computing platform for solving partial differential equations</span>
<span class="c1">#      distributed under the GNU Lesser General Public License (https://fenicsproject.org/)</span>

<span class="c1">##################################</span>
<span class="c1"># 3D elastic waveguide example\</span>
<span class="c1"># The cross-section is a 2D circle with free boundary conditions on its 1D boundaries, material: elastic steel\</span>
<span class="c1"># The waveguide FE formulation (SAFE) leads to the following eigenvalue problem:\</span>
<span class="c1"># $(\textbf{K}_1-\omega^2\textbf{M}+\text{i}k(\textbf{K}_2+\textbf{K}_2^\text{T})+k^2\textbf{K}_3)\textbf{U}=\textbf{0}$\</span>
<span class="c1"># This eigenproblem is solved with the varying parameter as the frequency (eigenvalues are then wavenumbers).\</span>
<span class="c1"># The forced response is computed for a point force at the center node ot the cross-section.\</span>
<span class="c1"># Results are to be compared with Figs. 5, 6 and 7 of paper: Treyssede, Wave Motion 87 (2019), 75-91.</span>

<span class="kn">import</span> <span class="nn">gmsh</span> <span class="c1">#full documentation entirely defined in the `gmsh.py&#39; module</span>
<span class="kn">import</span> <span class="nn">dolfinx</span>
<span class="kn">import</span> <span class="nn">ufl</span>
<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">from</span> <span class="nn">petsc4py</span> <span class="kn">import</span> <span class="n">PETSc</span>
<span class="kn">from</span> <span class="nn">slepc4py</span> <span class="kn">import</span> <span class="n">SLEPc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pyvista</span>

<span class="kn">from</span> <span class="nn">waveguicsx.waveguide</span> <span class="kn">import</span> <span class="n">Waveguide</span>
<span class="c1">#For proper use with a jupyter notebook, uncomment the following line:</span>
<span class="c1">#pyvista.set_jupyter_backend(&quot;none&quot;); pyvista.start_xvfb() #try also: &quot;static&quot;, &quot;pythreejs&quot;, &quot;ipyvtklink&quot;...</span>

<span class="c1">##################################</span>
<span class="c1"># Input parameters</span>
<span class="n">a</span> <span class="o">=</span> <span class="mf">2.7e-3</span> <span class="c1">#cross-section radius (m)</span>
<span class="n">le</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="mi">8</span> <span class="c1">#finite element characteristic length (m)</span>
<span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="mi">7800</span><span class="p">,</span> <span class="mi">3296</span><span class="p">,</span> <span class="mi">5963</span> <span class="c1">#density (kg/m3), shear and longitudinal wave celerities (m/s)</span>
<span class="n">kappas</span><span class="p">,</span> <span class="n">kappal</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="mf">0.008</span><span class="p">,</span> <span class="mi">0</span><span class="o">*</span><span class="mf">0.003</span> <span class="c1">#shear and longitudinal bulk wave attenuations (Np/wavelength)</span>
<span class="n">omega</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">10.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">*</span><span class="n">cs</span><span class="o">/</span><span class="n">a</span> <span class="c1">#angular frequencies (rad/s)</span>
<span class="n">nev</span> <span class="o">=</span> <span class="mi">60</span> <span class="c1">#number of eigenvalues</span>

<span class="c1">##################################</span>
<span class="c1"># Re-scaling</span>
<span class="n">L0</span> <span class="o">=</span> <span class="n">a</span> <span class="c1">#characteristic length</span>
<span class="n">T0</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">cs</span> <span class="c1">#characteristic time</span>
<span class="n">M0</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">a</span><span class="o">**</span><span class="mi">3</span><span class="c1">#characteristic mass</span>
<span class="n">a</span><span class="p">,</span> <span class="n">le</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">L0</span><span class="p">,</span> <span class="n">le</span><span class="o">/</span><span class="n">L0</span>
<span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">rho</span><span class="o">/</span><span class="n">M0</span><span class="o">*</span><span class="n">L0</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="n">cs</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span><span class="p">,</span> <span class="n">cl</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span>
<span class="n">omega</span> <span class="o">=</span> <span class="n">omega</span><span class="o">*</span><span class="n">T0</span>
<span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">cs</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappas</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="n">cl</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappal</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="c1">#complex celerities</span>

<span class="c1">##################################</span>
<span class="c1"># Create mesh from Gmsh and finite elements (six-node triangles with three dofs per node for the three components of displacement)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
<span class="c1"># Core</span>
<span class="n">origin</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="o">+</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addCircleArc</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addCircleArc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addCircleArc</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addCircleArc</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addCurveLoop</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">disk</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPlaneSurface</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
<span class="c1"># Physical groups</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span> <span class="c1">#the CAD entities must be synchronized with the Gmsh model</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addPhysicalGroup</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="n">disk</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#2: for 2D (surface)</span>
<span class="c1">#gmsh.model.addPhysicalGroup(1, [1, 2, 3, 4], tag=11) #1: for 1D (line)</span>
<span class="c1"># Generate mesh</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">embed</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">origin</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="n">disk</span><span class="p">)</span> <span class="c1">#ensure node points at the origin</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#generate a 2D mesh</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">setOrder</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#interpolation order for the geometry, here 2nd order</span>
<span class="c1"># From gmsh to fenicsx</span>
<span class="n">mesh</span><span class="p">,</span> <span class="n">cell_tags</span><span class="p">,</span> <span class="n">facet_tags</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">gmshio</span><span class="o">.</span><span class="n">model_to_mesh</span><span class="p">(</span><span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gdim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># # Reminder for save &amp; read</span>
<span class="c1"># gmsh.write(&quot;Elastic_Waveguide_Bar3D_Open.msh&quot;) #save to disk</span>
<span class="c1"># mesh, cell_tags, facet_tags = dolfinx.io.gmshio.read_from_msh(&quot;Elastic_Waveguide_Bar3D_Open.msh&quot;, MPI.COMM_WORLD, rank=0, gdim=2)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span> <span class="c1">#called when done using the Gmsh Python API</span>
<span class="c1"># Visualize FE mesh with pyvista</span>
<span class="n">Vmesh</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">ufl</span><span class="o">.</span><span class="n">FiniteElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="s2">&quot;triangle&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="c1">#order 1 is properly handled with pyvista</span>
<span class="n">plotter</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">Plotter</span><span class="p">()</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">Vmesh</span><span class="p">))</span>
<span class="n">grid</span><span class="o">.</span><span class="n">cell_data</span><span class="p">[</span><span class="s2">&quot;Marker&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_tags</span><span class="o">.</span><span class="n">values</span>
<span class="n">grid</span><span class="o">.</span><span class="n">set_active_scalars</span><span class="p">(</span><span class="s2">&quot;Marker&quot;</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">view_xy</span><span class="p">()</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1"># Finite element space</span>
<span class="n">element</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">VectorElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="s2">&quot;triangle&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="c1">#Lagrange element, triangle, quadratic &quot;P2&quot;, 3D vector</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Create Material properties (isotropic)</span>
<span class="k">def</span> <span class="nf">isotropic_law</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span><span class="p">):</span>
    <span class="n">E</span><span class="p">,</span> <span class="n">nu</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">C11</span> <span class="o">=</span> <span class="n">C22</span> <span class="o">=</span> <span class="n">C33</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">nu</span><span class="p">)</span>
    <span class="n">C12</span> <span class="o">=</span> <span class="n">C13</span> <span class="o">=</span> <span class="n">C23</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="n">nu</span>
    <span class="n">C44</span> <span class="o">=</span> <span class="n">C55</span> <span class="o">=</span> <span class="n">C66</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">C11</span><span class="p">,</span><span class="n">C12</span><span class="p">,</span><span class="n">C13</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="n">C12</span><span class="p">,</span><span class="n">C22</span><span class="p">,</span><span class="n">C23</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="n">C13</span><span class="p">,</span><span class="n">C23</span><span class="p">,</span><span class="n">C33</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C44</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C55</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C66</span><span class="p">]])</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">isotropic_law</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span><span class="p">)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ScalarType</span><span class="p">(</span><span class="n">C</span><span class="p">))</span>

<span class="c1">##################################</span>
<span class="c1"># Create free boundary conditions</span>
<span class="n">bcs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1">##################################</span>
<span class="c1"># Define variational problem (SAFE method)</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TrialFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TestFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">Lxy</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)])</span>
<span class="n">Lz</span>  <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">k1</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lxy</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lxy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k1_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span>
<span class="n">k2</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lxy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k2_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span>
<span class="n">k3</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lz</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k3_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k3</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">mass_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Build PETSc matrices</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">mass_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">M</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K0</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k1_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">)</span>
<span class="n">K0</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K1</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k2_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">K1</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K2</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k3_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">K2</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Solve the eigenproblem with SLEPc (the parameter is omega, the eigenvalue is k)</span>
<span class="n">wg</span> <span class="o">=</span> <span class="n">Waveguide</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">K0</span><span class="p">,</span> <span class="n">K1</span><span class="p">,</span> <span class="n">K2</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">omega</span><span class="o">=</span><span class="n">omega</span><span class="p">,</span> <span class="n">two_sided</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">evp</span><span class="o">.</span><span class="n">setTolerances</span><span class="p">(</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">max_it</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">nev</span><span class="o">=</span><span class="n">nev</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#access to components with: wg.eigenvalues[ik][imode], wg.eigenvectors[ik][idof,imode]</span>

<span class="c1">##################################</span>
<span class="c1"># Plot dispersion curves\</span>
<span class="c1"># Results are to be compared with Fig. 5 of Treyssede, Wave Motion 87 (2019), 75-91</span>
<span class="n">wg</span><span class="o">.</span><span class="n">plot_energy_velocity</span><span class="p">(</span><span class="n">direction</span><span class="o">=+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Excitation force definition (point force)</span>
<span class="n">dof_coords</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">tabulate_dof_coordinates</span><span class="p">()</span>
<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="c1">#desired coordinate of point force</span>
<span class="n">dof</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dof_coords</span> <span class="o">-</span> <span class="n">x0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span> <span class="c1">#find nearest dof</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Point force coordinates (nearest dof):  </span><span class="si">{</span><span class="p">(</span><span class="n">dof_coords</span><span class="p">[</span><span class="n">dof</span><span class="p">,:])</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#check</span>
<span class="n">F0</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">createVecRight</span><span class="p">()</span>
<span class="n">dof</span> <span class="o">=</span> <span class="n">dof</span><span class="o">*</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span> <span class="c1">#orientation along z</span>
<span class="c1">#dof = dof - 2 #uncomment this line for an orientation along x instead</span>
<span class="n">F0</span><span class="p">[</span><span class="n">dof</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="c1">##Uncomment lines below for distributed excitation</span>
<span class="c1">#body_force = dolfinx.fem.Constant(mesh, PETSc.ScalarType((0, 0, 1))) #body force of unit amplitude along z</span>
<span class="c1">#traction = dolfinx.fem.Constant(mesh, PETSc.ScalarType((0, 0, 0))) #zero traction</span>
<span class="c1">#ds = ufl.Measure(&quot;ds&quot;, domain=mesh)</span>
<span class="c1">#f = ufl.inner(body_force, v) * ufl.dx + ufl.inner(traction, v) * ds</span>
<span class="c1">#f_form = dolfinx.fem.form(f)</span>
<span class="c1">#F = dolfinx.fem.petsc.assemble_vector(f_form)</span>
<span class="c1">#F.assemble()</span>

<span class="c1">##################################</span>
<span class="c1"># Computation of excitability and forced response\</span>
<span class="c1"># Results are to be compared with Figs. 6 and 7 of Treyssede, Wave Motion 87 (2019), 75-91</span>
<span class="n">wg</span><span class="o">.</span><span class="n">compute_response_coefficient</span><span class="p">(</span><span class="n">F</span><span class="o">=</span><span class="n">F0</span><span class="p">,</span> <span class="n">dof</span><span class="o">=</span><span class="n">dof</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">plot_coefficient</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">plot_excitability</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">1e-3</span><span class="p">,</span><span class="mf">0.5e+1</span><span class="p">)</span>
<span class="n">frequency</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">compute_response</span><span class="p">(</span><span class="n">dof</span><span class="o">=</span><span class="n">dof</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">spectrum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#spectrum=excitation.spectrum</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">1e-2</span><span class="p">,</span><span class="mf">1e+1</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Mode shape visualization</span>
<span class="n">ik</span><span class="p">,</span> <span class="n">imode</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">1</span> <span class="c1">#parameter index, mode index to visualize</span>
<span class="n">vec</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">eigenvectors</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span><span class="o">.</span><span class="n">getColumnVector</span><span class="p">(</span><span class="n">imode</span><span class="p">)</span>
<span class="n">u_grid</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">V</span><span class="p">))</span>
<span class="n">u_grid</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="o">/</span><span class="n">V</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">value_shape</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">value_shape</span><span class="p">))</span> <span class="c1">#V.element.value_shape is equal to 3</span>
<span class="n">u_plotter</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">Plotter</span><span class="p">()</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;wireframe&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span> <span class="c1">#FE mesh</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">u_grid</span><span class="o">.</span><span class="n">warp_by_vector</span><span class="p">(</span><span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">show_scalar_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1">#do not show edges of higher order elements with pyvista</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">show_axes</span><span class="p">()</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="s2">&quot;&quot;</span>

</pre></div>
</div>
</section>
<section id="elastic-waveguide-circularbar3d-forcedresponse-gmsh-parallelizedloop-py">
<h2>Elastic_Waveguide_CircularBar3D_ForcedResponse_Gmsh_ParallelizedLoop.py<a class="headerlink" href="#elastic-waveguide-circularbar3d-forcedresponse-gmsh-parallelizedloop-py" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This file is a tutorial for waveguicsx (*), whose inputs are</span>
<span class="c1"># the matrices K0, K1, K2, M and the excitation vector F.</span>
<span class="c1"># In the tutorial, K0, K1, K2 and M are finite element matrices generated by FEnicSX (**).</span>
<span class="c1">#  (*) waveguicsx is a python library for solving complex waveguide problems</span>
<span class="c1">#      Copyright (C) 2023  Fabien Treyssede</span>
<span class="c1">#      waveguicsx is free software distributed under the GNU General Public License</span>
<span class="c1">#      (https://github.com/treyssede/waveguicsx)</span>
<span class="c1"># (**) FEniCSx is an open-source computing platform for solving partial differential equations</span>
<span class="c1">#      distributed under the GNU Lesser General Public License (https://fenicsproject.org/)</span>

<span class="c1">##################################</span>
<span class="c1"># 3D elastic waveguide example\</span>
<span class="c1"># The cross-section is a 2D circle with free boundary conditions on its 1D boundaries, material: elastic steel\</span>
<span class="c1"># The waveguide FE formulation (SAFE) leads to the following eigenvalue problem:\</span>
<span class="c1"># $(\textbf{K}_1-\omega^2\textbf{M}+\text{i}k(\textbf{K}_2+\textbf{K}_2^\text{T})+k^2\textbf{K}_3)\textbf{U}=\textbf{0}$\</span>
<span class="c1"># This eigenproblem is solved with the varying parameter as the frequency (eigenvalues are then wavenumbers).\</span>
<span class="c1"># The forced response is computed for a point force at the center node ot the cross-section.\</span>
<span class="c1"># Results are to be compared with Figs. 5, 6 and 7 of paper: Treyssede, Wave Motion 87 (2019), 75-91.</span>
<span class="c1"># In this example:</span>
<span class="c1"># - the parameter loop (here, the frequency loop) is distributed on all processes</span>
<span class="c1"># - FE mesh and matrices are (therefore) built on each local process</span>
<span class="c1"># Reminder for an execution in parallel mode (e.g. 8 processes):</span>
<span class="c1">#  mpiexec -n 8 python3 Elastic_Waveguide_CircularBar3D_ForcedResponse_Gmsh_ParallelizedLoop.py</span>

<span class="kn">import</span> <span class="nn">gmsh</span> <span class="c1">#full documentation entirely defined in the `gmsh.py&#39; module</span>
<span class="kn">import</span> <span class="nn">dolfinx</span>
<span class="kn">import</span> <span class="nn">ufl</span>
<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">from</span> <span class="nn">petsc4py</span> <span class="kn">import</span> <span class="n">PETSc</span>
<span class="kn">from</span> <span class="nn">slepc4py</span> <span class="kn">import</span> <span class="n">SLEPc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="c1">#import pyvista</span>

<span class="kn">from</span> <span class="nn">waveguicsx.waveguide</span> <span class="kn">import</span> <span class="n">Waveguide</span>
<span class="c1">#For proper use with a jupyter notebook, uncomment the following line:</span>
<span class="c1">#pyvista.set_jupyter_backend(&quot;none&quot;); pyvista.start_xvfb() #try also: &quot;static&quot;, &quot;pythreejs&quot;, &quot;ipyvtklink&quot;...</span>

<span class="c1">##################################</span>
<span class="c1"># Input parameters</span>
<span class="n">a</span> <span class="o">=</span> <span class="mf">2.7e-3</span> <span class="c1">#cross-section radius (m)</span>
<span class="n">le</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="mi">8</span> <span class="c1">#finite element characteristic length (m)</span>
<span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="mi">7800</span><span class="p">,</span> <span class="mi">3296</span><span class="p">,</span> <span class="mi">5963</span> <span class="c1">#density (kg/m3), shear and longitudinal wave celerities (m/s)</span>
<span class="n">kappas</span><span class="p">,</span> <span class="n">kappal</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="mf">0.008</span><span class="p">,</span> <span class="mi">0</span><span class="o">*</span><span class="mf">0.003</span> <span class="c1">#shear and longitudinal bulk wave attenuations (Np/wavelength)</span>
<span class="n">omega</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">10.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">*</span><span class="n">cs</span><span class="o">/</span><span class="n">a</span> <span class="c1">#angular frequencies (rad/s)</span>
<span class="n">nev</span> <span class="o">=</span> <span class="mi">300</span> <span class="c1">#number of eigenvalues</span>

<span class="c1">##################################</span>
<span class="c1"># Re-scaling</span>
<span class="n">L0</span> <span class="o">=</span> <span class="n">a</span> <span class="c1">#characteristic length</span>
<span class="n">T0</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">cs</span> <span class="c1">#characteristic time</span>
<span class="n">M0</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">a</span><span class="o">**</span><span class="mi">3</span><span class="c1">#characteristic mass</span>
<span class="n">a</span><span class="p">,</span> <span class="n">le</span> <span class="o">=</span> <span class="n">a</span><span class="o">/</span><span class="n">L0</span><span class="p">,</span> <span class="n">le</span><span class="o">/</span><span class="n">L0</span>
<span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">rho</span><span class="o">/</span><span class="n">M0</span><span class="o">*</span><span class="n">L0</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="n">cs</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span><span class="p">,</span> <span class="n">cl</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span>
<span class="n">omega</span> <span class="o">=</span> <span class="n">omega</span><span class="o">*</span><span class="n">T0</span>
<span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">cs</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappas</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="n">cl</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappal</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="c1">#complex celerities</span>

<span class="c1">##################################</span>
<span class="c1"># Create mesh from Gmsh and finite elements (six-node triangles with three dofs per node for the three components of displacement)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
<span class="c1"># Core</span>
<span class="n">origin</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="o">+</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="o">+</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">+</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addCircleArc</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addCircleArc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addCircleArc</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addCircleArc</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addCurveLoop</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">disk</span> <span class="o">=</span> <span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">addPlaneSurface</span><span class="p">([</span><span class="mi">1</span><span class="p">])</span>
<span class="c1"># Physical groups</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">geo</span><span class="o">.</span><span class="n">synchronize</span><span class="p">()</span> <span class="c1">#the CAD entities must be synchronized with the Gmsh model</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">addPhysicalGroup</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="n">disk</span><span class="p">],</span> <span class="n">tag</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#2: for 2D (surface)</span>
<span class="c1">#gmsh.model.addPhysicalGroup(1, [1, 2, 3, 4], tag=11) #1: for 1D (line)</span>
<span class="c1"># Generate mesh</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">embed</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">origin</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="n">disk</span><span class="p">)</span> <span class="c1">#ensure node points at the origin</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#generate a 2D mesh</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">setOrder</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#interpolation order for the geometry, here 2nd order</span>
<span class="c1"># From gmsh to fenicsx</span>
<span class="n">mesh</span><span class="p">,</span> <span class="n">cell_tags</span><span class="p">,</span> <span class="n">facet_tags</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">gmshio</span><span class="o">.</span><span class="n">model_to_mesh</span><span class="p">(</span><span class="n">gmsh</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_SELF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gdim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#MPI.COMM_SELF = FE mesh is built on each local process</span>
<span class="c1"># # Reminder for save &amp; read</span>
<span class="c1"># gmsh.write(&quot;Elastic_Waveguide_Bar3D_Open.msh&quot;) #save to disk</span>
<span class="c1"># mesh, cell_tags, facet_tags = dolfinx.io.gmshio.read_from_msh(&quot;Elastic_Waveguide_Bar3D_Open.msh&quot;, MPI.COMM_WORLD, rank=0, gdim=2)</span>
<span class="n">gmsh</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span> <span class="c1">#called when done using the Gmsh Python API</span>
<span class="c1"># Finite element space</span>
<span class="n">element</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">VectorElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="s2">&quot;triangle&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="c1">#Lagrange element, triangle, quadratic &quot;P2&quot;, 3D vector</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Create Material properties (isotropic)</span>
<span class="k">def</span> <span class="nf">isotropic_law</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span><span class="p">):</span>
    <span class="n">E</span><span class="p">,</span> <span class="n">nu</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">C11</span> <span class="o">=</span> <span class="n">C22</span> <span class="o">=</span> <span class="n">C33</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">nu</span><span class="p">)</span>
    <span class="n">C12</span> <span class="o">=</span> <span class="n">C13</span> <span class="o">=</span> <span class="n">C23</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="n">nu</span>
    <span class="n">C44</span> <span class="o">=</span> <span class="n">C55</span> <span class="o">=</span> <span class="n">C66</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">C11</span><span class="p">,</span><span class="n">C12</span><span class="p">,</span><span class="n">C13</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="n">C12</span><span class="p">,</span><span class="n">C22</span><span class="p">,</span><span class="n">C23</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="n">C13</span><span class="p">,</span><span class="n">C23</span><span class="p">,</span><span class="n">C33</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C44</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C55</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C66</span><span class="p">]])</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">isotropic_law</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span><span class="p">)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ScalarType</span><span class="p">(</span><span class="n">C</span><span class="p">))</span>

<span class="c1">##################################</span>
<span class="c1"># Create free boundary conditions</span>
<span class="n">bcs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1">##################################</span>
<span class="c1"># Define variational problem (SAFE method)</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TrialFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TestFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">Lxy</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)])</span>
<span class="n">Lz</span>  <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
<span class="n">k1</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lxy</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lxy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k1_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span>
<span class="n">k2</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lxy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k2_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span>
<span class="n">k3</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lz</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k3_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k3</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">mass_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Build PETSc matrices</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">mass_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">M</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K0</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k1_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">)</span>
<span class="n">K0</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K1</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k2_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">K1</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K2</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k3_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">K2</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Excitation force definition (point force)</span>
<span class="n">dof_coords</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">tabulate_dof_coordinates</span><span class="p">()</span>
<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="c1">#desired coordinate of point force</span>
<span class="n">dof</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dof_coords</span> <span class="o">-</span> <span class="n">x0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span> <span class="c1">#find nearest dof</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Point force coordinates (nearest dof):  </span><span class="si">{</span><span class="p">(</span><span class="n">dof_coords</span><span class="p">[</span><span class="n">dof</span><span class="p">,:])</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#check</span>
<span class="n">F0</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">createVecRight</span><span class="p">()</span>
<span class="n">dof</span> <span class="o">=</span> <span class="n">dof</span><span class="o">*</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span> <span class="c1">#orientation along z</span>
<span class="n">dof</span> <span class="o">=</span> <span class="n">dof</span> <span class="o">-</span> <span class="mi">2</span> <span class="c1">#uncomment this line for an orientation along x instead</span>
<span class="n">F0</span><span class="p">[</span><span class="n">dof</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="c1">##Uncomment lines below for distributed excitation</span>
<span class="c1">#body_force = dolfinx.fem.Constant(mesh, PETSc.ScalarType((0, 0, 1))) #body force of unit amplitude along z</span>
<span class="c1">#traction = dolfinx.fem.Constant(mesh, PETSc.ScalarType((0, 0, 0))) #zero traction</span>
<span class="c1">#ds = ufl.Measure(&quot;ds&quot;, domain=mesh)</span>
<span class="c1">#f = ufl.inner(body_force, v) * ufl.dx + ufl.inner(traction, v) * ds</span>
<span class="c1">#f_form = dolfinx.fem.form(f)</span>
<span class="c1">#F = dolfinx.fem.petsc.assemble_vector(f_form)</span>
<span class="c1">#F.assemble()</span>

<span class="c1">##################################</span>
<span class="c1"># Parallelization</span>
<span class="n">comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span> <span class="c1">#use all processes for the loop</span>
<span class="n">size</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>  <span class="c1">#number of processors</span>
<span class="n">rank</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>  <span class="c1">#returns the rank of the process that called it within comm_world</span>
<span class="c1"># Split the parameter range and scatter to all</span>
<span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1">#define on rank 0 only</span>
    <span class="n">omega_split</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">omega</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="c1">#split param in blocks of length size roughly</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">omega_split</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">omega_local</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">omega_split</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#scatter 1 block per process</span>

<span class="c1">##################################</span>
<span class="c1"># Solve the eigenproblem with SLEPc (the parameter is omega, the eigenvalue is k)</span>
<span class="n">wg</span> <span class="o">=</span> <span class="n">Waveguide</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_SELF</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">K0</span><span class="p">,</span> <span class="n">K1</span><span class="p">,</span> <span class="n">K2</span><span class="p">)</span> <span class="c1">#MPI.COMM_SELF = SLEPc will used FE matrices on each local process</span>
<span class="n">wg</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">omega</span><span class="o">=</span><span class="n">omega_local</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">evp</span><span class="o">.</span><span class="n">setTolerances</span><span class="p">(</span><span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">max_it</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">nev</span><span class="o">=</span><span class="n">nev</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#access to components with: wg.eigenvalues[ik][imode], wg.eigenvectors[ik][idof,imode]</span>

<span class="c1">##################################</span>
<span class="c1"># Computation of excitability and forced response</span>
<span class="n">wg</span><span class="o">.</span><span class="n">compute_response_coefficient</span><span class="p">(</span><span class="n">F</span><span class="o">=</span><span class="n">F0</span><span class="p">,</span> <span class="n">dof</span><span class="o">=</span><span class="n">dof</span><span class="p">)</span>
<span class="n">frequency</span><span class="p">,</span> <span class="n">response</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">compute_response</span><span class="p">(</span><span class="n">dof</span><span class="o">=</span><span class="n">dof</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="c1">#spectrum=excitation.spectrum</span>

<span class="c1">##################################</span>
<span class="c1"># Gather</span>
<span class="n">wg</span><span class="o">.</span><span class="n">omega</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">reduce</span><span class="p">([</span><span class="n">wg</span><span class="o">.</span><span class="n">omega</span><span class="p">],</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#reduce works for lists: brackets are necessary (wg.omega is not a list but a numpy array)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">eigenvalues</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">eigenvalues</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="c1">#wg.eigenvectors = comm.reduce(wg.eigenvectors, op=MPI.SUM, root=0) #don&#39;t do this line: reduce cannot pickle &#39;petsc4py.PETSc.Vec&#39; objects (keep the mode shapes distributed on each processor rather than gather them)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">coefficient</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">coefficient</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">excitability</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">excitability</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">frequency</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">reduce</span><span class="p">([</span><span class="n">frequency</span><span class="p">],</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">reduce</span><span class="p">([</span><span class="n">response</span><span class="p">],</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">SUM</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Plots</span>
<span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">wg</span><span class="o">.</span><span class="n">omega</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">wg</span><span class="o">.</span><span class="n">omega</span><span class="p">)</span> <span class="c1">#wg.omega is transformed to a numpy array for a proper use of wg.plot()</span>
    <span class="n">wg</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
    <span class="n">wg</span><span class="o">.</span><span class="n">plot_coefficient</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">plot_excitability</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">1e-3</span><span class="p">,</span><span class="mf">0.5e+1</span><span class="p">)</span>
    <span class="n">frequency</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="c1">#use np.concatenate(response, axis=1)  if z contains more than one value</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;frequency&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;|u|&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">1e-2</span><span class="p">,</span><span class="mf">1e+1</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="c1">#plt.savefig(&quot;figure_name.svg&quot;)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

</pre></div>
</div>
</section>
<section id="elastic-waveguide-plate2d-transientresponse-py">
<h2>Elastic_Waveguide_Plate2D_TransientResponse.py<a class="headerlink" href="#elastic-waveguide-plate2d-transientresponse-py" title="Permalink to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># This file is a tutorial for waveguicsx (*), whose inputs are</span>
<span class="c1"># the matrices K0, K1, K2, M and the excitation vector F.</span>
<span class="c1"># In the tutorial, K0, K1, K2 and M are finite element matrices generated by FEnicSX (**).</span>
<span class="c1">#  (*) waveguicsx is a python library for solving complex waveguide problems</span>
<span class="c1">#      Copyright (C) 2023  Fabien Treyssede</span>
<span class="c1">#      waveguicsx is free software distributed under the GNU General Public License</span>
<span class="c1">#      (https://github.com/treyssede/waveguicsx)</span>
<span class="c1"># (**) FEniCSx is an open-source computing platform for solving partial differential equations</span>
<span class="c1">#      distributed under the GNU Lesser General Public License (https://fenicsproject.org/)</span>

<span class="c1">##################################</span>
<span class="c1"># 2D (visco-)elastic waveguide example (Lamb modes in a plate excited near 1st ZGV resonance)\</span>
<span class="c1"># The cross-section is a 1D line with free boundary conditions on its boundaries\</span>
<span class="c1"># material: viscoelastic steel\</span>
<span class="c1"># The waveguide FE formulation (SAFE) leads to the following eigenvalue problem:\</span>
<span class="c1"># $(\textbf{K}_1-\omega^2\textbf{M}+\text{i}k(\textbf{K}_2+\textbf{K}_2^\text{T})+k^2\textbf{K}_3)\textbf{U}=\textbf{0}$\</span>
<span class="c1"># This eigenproblem is solved with the varying parameter as the frequency (eigenvalues are then wavenumbers)\</span>
<span class="c1"># Viscoelastic loss can be included by introducing imaginary parts (negative) to wave celerities\</span>
<span class="c1"># Results are to be compared with Figs. 5b, 7a and 8a of paper: Treyssede and Laguerre, JASA 133 (2013), 3827-3837\</span>
<span class="c1"># Note: the depth direction is x, the axis of propagation is z</span>

<span class="kn">import</span> <span class="nn">dolfinx</span>
<span class="kn">import</span> <span class="nn">ufl</span>
<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">from</span> <span class="nn">petsc4py</span> <span class="kn">import</span> <span class="n">PETSc</span>
<span class="kn">from</span> <span class="nn">slepc4py</span> <span class="kn">import</span> <span class="n">SLEPc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pyvista</span>

<span class="kn">from</span> <span class="nn">waveguicsx.waveguide</span> <span class="kn">import</span> <span class="n">Waveguide</span><span class="p">,</span> <span class="n">Signal</span>
<span class="c1">#For proper use with a jupyter notebook, uncomment the following line:</span>
<span class="c1">#pyvista.set_jupyter_backend(&quot;none&quot;); pyvista.start_xvfb() #try also: &quot;static&quot;, &quot;pythreejs&quot;, &quot;ipyvtklink&quot;...</span>

<span class="c1">##################################</span>
<span class="c1"># Input parameters</span>
<span class="n">h</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="c1">#core half-length (m)</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1">#number of finite elements along one half-side</span>
<span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="mi">7800</span><span class="p">,</span> <span class="mi">3218</span><span class="p">,</span> <span class="mi">6020</span> <span class="c1">#core density (kg/m3), shear and longitudinal wave celerities (m/s)</span>
<span class="n">kappas</span><span class="p">,</span> <span class="n">kappal</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="mf">0.008</span><span class="p">,</span> <span class="mi">0</span><span class="o">*</span><span class="mf">0.003</span> <span class="c1">#core shear and longitudinal bulk wave attenuations (Np/wavelength)</span>
<span class="n">nev</span> <span class="o">=</span> <span class="mi">20</span> <span class="c1">#number of eigenvalues</span>

<span class="c1">##################################</span>
<span class="c1"># Excitation spectrum</span>
<span class="n">excitation</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">/</span><span class="mf">5e-3</span><span class="p">)</span>
<span class="n">excitation</span><span class="o">.</span><span class="n">toneburst</span><span class="p">(</span><span class="n">fs</span><span class="o">=</span><span class="mf">1000e3</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mf">5e-3</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="mf">250e3</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">excitation</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">excitation</span><span class="o">.</span><span class="n">plot_spectrum</span><span class="p">()</span>
<span class="c1">#excitation.ifft(coeff=1); excitation.plot() #uncomment for check only</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">omega</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">excitation</span><span class="o">.</span><span class="n">frequency</span> <span class="c1">#angular frequency range (rad/s)</span>

<span class="c1">##################################</span>
<span class="c1"># Re-scaling</span>
<span class="n">L0</span> <span class="o">=</span> <span class="n">h</span> <span class="c1">#characteristic length</span>
<span class="n">T0</span> <span class="o">=</span> <span class="n">h</span><span class="o">/</span><span class="n">cs</span> <span class="c1">#characteristic time</span>
<span class="n">M0</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">h</span><span class="o">**</span><span class="mi">3</span><span class="c1">#characteristic mass</span>
<span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">/</span><span class="n">L0</span>
<span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">rho</span><span class="o">/</span><span class="n">M0</span><span class="o">*</span><span class="n">L0</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span> <span class="n">cs</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span><span class="p">,</span> <span class="n">cl</span><span class="o">/</span><span class="n">L0</span><span class="o">*</span><span class="n">T0</span>
<span class="n">omega</span> <span class="o">=</span> <span class="n">omega</span><span class="o">*</span><span class="n">T0</span>
<span class="n">cs</span><span class="p">,</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">cs</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappas</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span> <span class="n">cl</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">kappal</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="c1">#complex celerities (core)</span>

<span class="c1">##################################</span>
<span class="c1"># Create mesh and finite elements (three-node lines with two dofs per node for the two components of displacement)</span>
<span class="n">mesh</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">create_interval</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">h</span><span class="p">]))</span>
<span class="n">element</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">VectorElement</span><span class="p">(</span><span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="s2">&quot;interval&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1">#Lagrange element, line element, quadratic &quot;P2&quot;, 2D vector</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Create Material properties (isotropic)</span>
<span class="k">def</span> <span class="nf">isotropic_law</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span><span class="p">):</span>
    <span class="n">E</span><span class="p">,</span> <span class="n">nu</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cl</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">cs</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">C11</span> <span class="o">=</span> <span class="n">C22</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">nu</span><span class="p">)</span>
    <span class="n">C12</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="n">nu</span>
    <span class="n">C33</span> <span class="o">=</span> <span class="n">E</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">C11</span><span class="p">,</span><span class="n">C12</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> 
            <span class="p">(</span><span class="n">C12</span><span class="p">,</span><span class="n">C22</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> 
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">C33</span><span class="p">))</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">isotropic_law</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">cl</span><span class="p">)</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">PETSc</span><span class="o">.</span><span class="n">ScalarType</span><span class="p">(</span><span class="n">C</span><span class="p">))</span>

<span class="c1">##################################</span>
<span class="c1"># Create free boundary conditions</span>
<span class="n">bcs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1">##################################</span>
<span class="c1"># Define variational problem (SAFE method)</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TrialFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">TestFunction</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
<span class="n">Lxy</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">)])</span>
<span class="n">Lz</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">u</span><span class="p">:</span> <span class="n">ufl</span><span class="o">.</span><span class="n">as_vector</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
<span class="n">k1</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lxy</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lxy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k1_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k1</span><span class="p">)</span>
<span class="n">k2</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lxy</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k2_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k2</span><span class="p">)</span>
<span class="n">k3</span> <span class="o">=</span> <span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">Lz</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">Lz</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">k3_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">k3</span><span class="p">)</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">ufl</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">ufl</span><span class="o">.</span><span class="n">dx</span>
<span class="n">mass_form</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="c1">##################################</span>
<span class="c1"># Build PETSc matrices</span>
<span class="n">M</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">mass_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">M</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K0</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k1_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">)</span>
<span class="n">K0</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K1</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k2_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">K1</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
<span class="n">K2</span> <span class="o">=</span> <span class="n">dolfinx</span><span class="o">.</span><span class="n">fem</span><span class="o">.</span><span class="n">petsc</span><span class="o">.</span><span class="n">assemble_matrix</span><span class="p">(</span><span class="n">k3_form</span><span class="p">,</span> <span class="n">bcs</span><span class="o">=</span><span class="n">bcs</span><span class="p">,</span> <span class="n">diagonal</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">K2</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Solve the eigenproblem with SLEPc\</span>
<span class="c1"># The parameter is omega, the eigenvalue is k</span>
<span class="n">wg</span> <span class="o">=</span> <span class="n">Waveguide</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">K0</span><span class="p">,</span> <span class="n">K1</span><span class="p">,</span> <span class="n">K2</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">set_parameters</span><span class="p">(</span><span class="n">omega</span><span class="o">=</span><span class="n">omega</span><span class="p">)</span>
<span class="n">wg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">nev</span><span class="p">)</span> <span class="c1">#access to components with: wg.eigenvalues[ik][imode], wg.eigenvectors[ik][idof,imode]</span>
<span class="n">wg</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span> <span class="c1">#blocking</span>

<span class="c1">###############################################################################</span>
<span class="c1"># Excitation force: point force at x=0 oriented in the x-direction</span>
<span class="n">dof_coords</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">tabulate_dof_coordinates</span><span class="p">()</span>
<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="c1">#desired coordinate of point force</span>
<span class="n">dof</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dof_coords</span> <span class="o">-</span> <span class="n">x0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span> <span class="c1">#find nearest dof</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Point force coordinates (nearest dof):  </span><span class="si">{</span><span class="p">(</span><span class="n">dof_coords</span><span class="p">[</span><span class="n">dof</span><span class="p">,:])</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#check</span>
<span class="n">F</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">createVecRight</span><span class="p">()</span>
<span class="n">dof</span> <span class="o">=</span> <span class="n">dof</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">0</span> <span class="c1">#x-direction</span>
<span class="n">F</span><span class="p">[</span><span class="n">dof</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1">###############################################################################</span>
<span class="c1"># Computation of excitabilities and forced response\</span>
<span class="c1"># Results are to be compared with Figs. 5b and 7a of Treyssede and Laguerre, JASA 133 (2013), 3827-3837</span>
<span class="n">wg</span><span class="o">.</span><span class="n">compute_response_coefficient</span><span class="p">(</span><span class="n">F</span><span class="o">=</span><span class="n">F</span><span class="p">,</span> <span class="n">dof</span><span class="o">=</span><span class="n">dof</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">plot_excitability</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">1e-3</span><span class="p">,</span><span class="mf">1e2</span><span class="p">)</span>
<span class="n">frequency</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">compute_response</span><span class="p">(</span><span class="n">dof</span><span class="o">=</span><span class="n">dof</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">h</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">=</span><span class="n">excitation</span><span class="o">.</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1">###############################################################################</span>
<span class="c1"># Time response\</span>
<span class="c1"># Results are to be compared with Fig. 8a of Treyssede and Laguerre, JASA 133 (2013), 3827-3837</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">,</span> <span class="n">spectrum</span><span class="o">=</span><span class="n">response</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="o">/</span><span class="mf">5e-3</span><span class="o">*</span><span class="n">T0</span><span class="p">)</span>
<span class="n">response</span><span class="o">.</span><span class="n">plot_spectrum</span><span class="p">()</span>
<span class="n">response</span><span class="o">.</span><span class="n">ifft</span><span class="p">(</span><span class="n">coeff</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">response</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Mesh visualization</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">dim</span><span class="p">))</span>
<span class="n">plotter</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">Plotter</span><span class="p">()</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;points&#39;</span><span class="p">,</span> <span class="n">render_points_as_spheres</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">point_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">view_xy</span><span class="p">()</span>
<span class="n">plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1">##################################</span>
<span class="c1"># Mode shape visualization</span>
<span class="n">ik</span><span class="p">,</span> <span class="n">imode</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">5</span> <span class="c1">#parameter index, mode index to visualize</span>
<span class="n">vec</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">eigenvectors</span><span class="p">[</span><span class="n">ik</span><span class="p">]</span><span class="o">.</span><span class="n">getColumnVector</span><span class="p">(</span><span class="n">imode</span><span class="p">)</span>
<span class="n">u_grid</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">UnstructuredGrid</span><span class="p">(</span><span class="o">*</span><span class="n">dolfinx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">create_vtk_mesh</span><span class="p">(</span><span class="n">V</span><span class="p">))</span>
<span class="n">u_grid</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="o">.</span><span class="n">real</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="o">/</span><span class="n">V</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">value_shape</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">value_shape</span><span class="p">))</span> <span class="c1">#V.element.value_shape is equal to 2</span>
<span class="n">u_grid</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">u_grid</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#insert a zero column to the second component (the y component)</span>
<span class="n">u_plotter</span> <span class="o">=</span> <span class="n">pyvista</span><span class="o">.</span><span class="n">Plotter</span><span class="p">()</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s2">&quot;wireframe&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span> <span class="c1">#FE mesh</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">u_grid</span><span class="o">.</span><span class="n">warp_by_vector</span><span class="p">(</span><span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">),</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">show_scalar_bar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1">#do not show edges of higher order elements with pyvista</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">view_zx</span><span class="p">()</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">show_axes</span><span class="p">()</span>
<span class="n">u_plotter</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="s2">&quot;&quot;</span>

</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="waveguicsx.html" class="btn btn-neutral float-left" title="waveguicsx.waveguide" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Fabien Treyssede.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>